<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>lin&#39;s blog home</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="personal blog">
<meta property="og:type" content="website">
<meta property="og:title" content="lin&#39;s blog home">
<meta property="og:url" content="https://veysky.github.io/blogOfLin/page/2/index.html">
<meta property="og:site_name" content="lin&#39;s blog home">
<meta property="og:description" content="personal blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/blogOfLin/atom.xml" title="lin&#39;s blog home" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/blogOfLin/css/style.css">

<meta name="generator" content="Hexo 5.0.2"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blogOfLin/" id="logo">lin&#39;s blog home</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/blogOfLin/">Home</a>
        
          <a class="main-nav-link" href="/blogOfLin/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/blogOfLin/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://veysky.github.io/blogOfLin"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-编程老司机带你玩转-CompletableFuture-异步编程" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blogOfLin/2020/11/16/%E7%BC%96%E7%A8%8B%E8%80%81%E5%8F%B8%E6%9C%BA%E5%B8%A6%E4%BD%A0%E7%8E%A9%E8%BD%AC-CompletableFuture-%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/" class="article-date">
  <time datetime="2020-11-16T13:09:48.000Z" itemprop="datePublished">2020-11-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blogOfLin/2020/11/16/%E7%BC%96%E7%A8%8B%E8%80%81%E5%8F%B8%E6%9C%BA%E5%B8%A6%E4%BD%A0%E7%8E%A9%E8%BD%AC-CompletableFuture-%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/">编程老司机带你玩转 CompletableFuture 异步编程</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本文从实例出发，介绍 <code>CompletableFuture</code> 基本用法。不过讲的再多，不如亲自上手练习一下。所以建议各位小伙伴看完，上机练习一把，快速掌握 <code>CompletableFuture</code>。</p>
<blockquote>
<p>转载地址：<a target="_blank" rel="noopener" href="https://sourl.cn/s5MbCm">https://sourl.cn/s5MbCm</a></p>
</blockquote>
<p><strong>全文摘要：</strong></p>
<ul>
<li><code>Future</code> VS <code>CompletableFuture</code></li>
<li><code>CompletableFuture</code> 基本用法</li>
</ul>
<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00. 前言"></a>0x00. 前言</h2><p>一些业务场景我们需要使用多线程异步执行任务，加快任务执行速度。 Java 提供 <code>Runnable</code> <code>Future&lt;V&gt;</code> 两个接口用来实现异步任务逻辑。</p>
<p>虽然 <code>Future&lt;V&gt;</code> 可以获取任务执行结果，但是获取方式十方不变。我们不得不使用<code>Future#get</code> 阻塞调用线程，或者使用轮询方式判断 <code>Future#isDone</code> 任务是否结束，再获取结果。</p>
<p>这两种处理方式都不是很优雅，JDK8 之前并发类库没有提供相关的异步回调实现方式。没办法，我们只好借助第三方类库，如 <code>Guava</code>，扩展 <code>Future</code>，增加支持回调功能。相关代码如下:</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-c42b2d87678baef55c701f7db740782e5fe.JPEG" alt="img"></p>
<p>虽然这种方式增强了 Java 异步编程能力，但是还是无法解决多个异步任务需要相互依赖的场景。</p>
<p>举一个生活上的例子，假如我们需要出去旅游，需要完成三个任务：</p>
<ul>
<li>任务一：订购航班</li>
<li>任务二：订购酒店</li>
<li>任务三：订购租车服务</li>
</ul>
<p>很显然任务一和任务二没有相关性，可以单独执行。但是任务三必须等待任务一与任务二结束之后，才能订购租车服务。</p>
<p>为了使任务三时执行时能获取到任务一与任务二执行结果，我们还需要借助 <code>CountDownLatch</code> 。</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-f7c663d510c5ccaa0aecbdc08592b9cd1fa.JPEG" alt="img"></p>
<h2 id="0x01-CompletableFuture"><a href="#0x01-CompletableFuture" class="headerlink" title="0x01. CompletableFuture"></a>0x01. CompletableFuture</h2><p>JDK8 之后，Java 新增一个功能十分强大的类：<code>CompletableFuture</code>。单独使用这个类就可以轻松的完成上面的需求:</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-c4cb12b1605a1b8c1b91c136837da417f75.JPEG" alt="img"></p>
<blockquote>
<p>大家可以先不用管 <code>CompletableFuture</code> 相关 <code>API</code>，下面将会具体讲解。</p>
</blockquote>
<p>对比 <code>Future&lt;V&gt;</code>，<code>CompletableFuture</code> 优点在于：</p>
<ul>
<li>不需要手工分配线程，JDK 自动分配</li>
<li>代码语义清晰，异步任务链式调用</li>
<li>支持编排异步任务</li>
</ul>
<p>怎么样，是不是功能很强大？接下来抓稳了，小黑哥要发车了。</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-777ed5094fbba4e4225b9d1c6d936bb8457.gif" alt="img"></p>
<h3 id="1-1-方法一览"><a href="#1-1-方法一览" class="headerlink" title="1.1 方法一览"></a>1.1 方法一览</h3><p>首先来通过 IDE 查看下这个类提供的方法：</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-e06a7b173412a6a0ba058363c2ef57146a3.JPEG" alt="img"></p>
<p>稍微数一下，这个类总共有 50 多个方法，我的天。。。</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-8c5992b3ff508b5ec511b81daa02ef9189e.JPEG" alt="img"></p>
<p>不过也不要怕，小黑哥帮你们归纳好了，跟着小黑哥的节奏，带你们掌握 <code>CompletableFuture</code>。</p>
<blockquote>
<p>若图片不清晰，可以关注『程序通事』，回复：『233』，获取该思维导图</p>
</blockquote>
<p><img src="https://oscimg.oschina.net/oscnet/up-d52a1726e6fd93e8a0c9df26daa980865b5.JPEG" alt="img"></p>
<h3 id="1-2-创建-CompletableFuture-实例"><a href="#1-2-创建-CompletableFuture-实例" class="headerlink" title="1.2 创建 CompletableFuture 实例"></a>1.2 创建 CompletableFuture 实例</h3><p>创建 <code>CompletableFuture</code> 对象实例我们可以使用如下几个方法：</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-b7de5aff615a3246206742d64013e3aff7d.JPEG" alt="img"></p>
<p>第一个方法创建一个具有默认结果的 <code>CompletableFuture</code>，这个没啥好讲。我们重点讲述下下面四个异步方法。</p>
<p>前两个方法 <code>runAsync</code> 不支持返回值，而 <code>supplyAsync</code>可以支持返回结果。</p>
<p>这个两个方法默认将会使用公共的 <code>ForkJoinPool</code> 线程池执行，这个线程池默认线程数是 <strong>CPU</strong> 的核数。</p>
<blockquote>
<p>可以设置 JVM option:-Djava.util.concurrent.ForkJoinPool.common.parallelism 来设置 ForkJoinPool 线程池的线程数</p>
</blockquote>
<p>使用共享线程池将会有个弊端，一旦有任务被阻塞，将会造成其他任务没机会执行。所以<strong>强烈</strong>建议使用后两个方法，根据任务类型不同，主动创建线程池，进行资源隔离，避免互相干扰。</p>
<h3 id="1-3-设置任务结果"><a href="#1-3-设置任务结果" class="headerlink" title="1.3 设置任务结果"></a>1.3 设置任务结果</h3><p><code>CompletableFuture</code> 提供以下方法，可以主动设置任务结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">complete</span><span class="params">(T value)</span></span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">completeExceptionally</span><span class="params">(Throwable ex)</span></span></span><br></pre></td></tr></table></figure>

<p>第一个方法，主动设置 <code>CompletableFuture</code> 任务执行结果，若返回 <code>true</code>，表示设置成功。如果返回 <code>false</code>，设置失败，这是因为任务已经执行结束，已经有了执行结果。</p>
<p>示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 执行异步任务</span></span><br><span class="line">CompletableFuture cf = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">  System.out.println(<span class="string">&quot;cf 任务执行开始&quot;</span>);</span><br><span class="line">  sleep(<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">  System.out.println(<span class="string">&quot;cf 任务执行结束&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;楼下小黑哥&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">Executors.newSingleThreadScheduledExecutor().execute(() -&gt; &#123;</span><br><span class="line">  sleep(<span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">  System.out.println(<span class="string">&quot;主动设置 cf 任务结果&quot;</span>);</span><br><span class="line">  <span class="comment">// 设置任务结果，由于 cf 任务未执行结束，结果返回 true</span></span><br><span class="line">  cf.complete(<span class="string">&quot;程序通事&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 由于 cf 未执行结束，将会被阻塞。5 秒后，另外一个线程主动设置任务结果</span></span><br><span class="line">System.out.println(<span class="string">&quot;get:&quot;</span> + cf.get());</span><br><span class="line"><span class="comment">// 等待 cf 任务执行结束</span></span><br><span class="line">sleep(<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line"><span class="comment">// 由于已经设置任务结果，cf 执行结束任务结果将会被抛弃</span></span><br><span class="line">System.out.println(<span class="string">&quot;get:&quot;</span> + cf.get());</span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment">   * cf 任务执行开始</span></span><br><span class="line"><span class="comment">   * 主动设置 cf 任务结果</span></span><br><span class="line"><span class="comment">   * get:程序通事</span></span><br><span class="line"><span class="comment">   * cf 任务执行结束</span></span><br><span class="line"><span class="comment">   * get:程序通事</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>这里需要注意一点，一旦 <code>complete</code> 设置成功，<code>CompletableFuture</code> 返回结果就不会被更改，即使后续 <code>CompletableFuture</code> 任务执行结束。</p>
<p>第二个方法，给 <code>CompletableFuture</code> 设置异常对象。若设置成功，如果调用 <code>get</code> 等方法获取结果，将会抛错。</p>
<p>示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 执行异步任务</span></span><br><span class="line">CompletableFuture cf = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;cf 任务执行开始&quot;</span>);</span><br><span class="line">    sleep(<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">    System.out.println(<span class="string">&quot;cf 任务执行结束&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;楼下小黑哥&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">Executors.newSingleThreadScheduledExecutor().execute(() -&gt; &#123;</span><br><span class="line">    sleep(<span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">    System.out.println(<span class="string">&quot;主动设置 cf 异常&quot;</span>);</span><br><span class="line">    <span class="comment">// 设置任务结果，由于 cf 任务未执行结束，结果返回 true</span></span><br><span class="line">    cf.completeExceptionally(<span class="keyword">new</span> RuntimeException(<span class="string">&quot;啊，挂了&quot;</span>));</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 由于 cf 未执行结束，前 5 秒将会被阻塞。后续程序抛出异常，结束</span></span><br><span class="line">System.out.println(<span class="string">&quot;get:&quot;</span> + cf.get());</span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * cf 任务执行开始</span></span><br><span class="line"><span class="comment"> * 主动设置 cf 异常</span></span><br><span class="line"><span class="comment"> * java.util.concurrent.ExecutionException: java.lang.RuntimeException: 啊，挂了</span></span><br><span class="line"><span class="comment"> * ......</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<h3 id="1-4-CompletionStage"><a href="#1-4-CompletionStage" class="headerlink" title="1.4 CompletionStage"></a>1.4 CompletionStage</h3><p><code>CompletableFuture</code> 分别实现两个接口 <code>Future</code>与 <code>CompletionStage</code>。</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-d7b6b9ca092770e607e2a46f3d817eaf1ab.JPEG" alt="img"></p>
<p><code>Future</code> 接口大家都比较熟悉，这里主要讲讲 <code>CompletionStage</code>。</p>
<p><code>CompletableFuture</code> 大部分方法来自<code>CompletionStage</code> 接口，正是因为这个接口，<code>CompletableFuture</code>才有如从强大功能。</p>
<p>想要理解 <code>CompletionStage</code> 接口，我们需要先了解任务的时序关系的。我们可以将任务时序关系分为以下几种：</p>
<ul>
<li>串行执行关系</li>
<li>并行执行关系</li>
<li>AND 汇聚关系</li>
<li>OR 汇聚关系</li>
</ul>
<h3 id="1-5-串行执行关系"><a href="#1-5-串行执行关系" class="headerlink" title="1.5 串行执行关系"></a>1.5 串行执行关系</h3><p>任务串行执行，下一个任务必须等待上一个任务完成才可以继续执行。</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-fd7c0a53e6da994bac1efdbfb16f535034a.JPEG" alt="img"></p>
<p><code>CompletionStage</code> 有四组接口可以描述串行这种关系，分别为:</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-65b7b2c16b980f2a88fb53f04e8fb1a55b0.JPEG" alt="img"></p>
<p><code>thenApply</code> 方法需要传入核心参数为 <code>Function&lt;T,R&gt;</code>类型。这个类核心方法为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">R <span class="title">apply</span><span class="params">(T t)</span></span></span><br></pre></td></tr></table></figure>

<p>所以这个接口将会把上一个任务返回结果当做入参，执行结束将会返回结果。</p>
<p><code>thenAccept</code> 方法需要传入参数对象为 <code>Consumer&lt;T&gt;</code>类型，这个类核心方法为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">accept</span><span class="params">(T t)</span></span></span><br></pre></td></tr></table></figure>

<p>返回值 <code>void</code> 可以看出，这个方法不支持返回结果，但是需要将上一个任务执行结果当做参数传入。</p>
<p><code>thenRun</code> 方法需要传入参数对象为 <code>Runnable</code> 类型，这个类大家应该都比较熟悉，核心方法既不支持传入参数，也不会返回执行结果。</p>
<p><code>thenCompose</code> 方法作用与 <code>thenApply</code> 一样，只不过 <code>thenCompose</code> 需要返回新的 <code>CompletionStage</code>。这么理解比较抽象，可以集合代码一起理解。</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-8fe697424d04aff6289b351ed634acc264a.JPEG" alt="img"></p>
<p>方法中带有 <strong>Async</strong> ，代表可以异步执行，这个系列还有重载方法，可以传入自定义的线程池，上图未展示，读者只可以自行查看 API。</p>
<p>最后我们通过代码展示 <code>thenApply</code> 使用方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;String&gt; cf</span><br><span class="line">        = CompletableFuture.supplyAsync(() -&gt; <span class="string">&quot;hello,楼下小黑哥&quot;</span>)<span class="comment">// 1</span></span><br><span class="line">        .thenApply(s -&gt; s + <span class="string">&quot;@程序通事&quot;</span>) <span class="comment">// 2</span></span><br><span class="line">        .thenApply(String::toUpperCase); <span class="comment">// 3</span></span><br><span class="line">System.out.println(cf.join());</span><br><span class="line"><span class="comment">// 输出结果 HELLO,楼下小黑哥@程序通事</span></span><br></pre></td></tr></table></figure>

<p>这段代码比较简单，首先我们开启一个异步任务，接着串行执行后续两个任务。任务 2 需要等待任务1 执行完成，任务 3 需要等待任务 2。</p>
<blockquote>
<p>上面方法，大家需要记住了 <code>Function&lt;T，R&gt;</code>，<code>Consumer&lt;T&gt;</code>，<code>Runnable</code> 三者区别，根据场景选择使用。</p>
</blockquote>
<h3 id="1-6-AND-汇聚关系"><a href="#1-6-AND-汇聚关系" class="headerlink" title="1.6 AND 汇聚关系"></a>1.6 AND 汇聚关系</h3><p>AND 汇聚关系代表所有任务完成之后，才能进行下一个任务。</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-adfc95c43a5a70f2fc825b348641da2ea97.JPEG" alt="img"></p>
<p>如上所示，只有任务 A 与任务 B 都完成之后，任务 C 才会开始执行。</p>
<p><code>CompletionStage</code> 有以下接口描述这种关系。</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-e17207d448150049e8ddd7e4fd90d272684.JPEG" alt="img"></p>
<p><code>thenCombine</code> 方法核心参数 <code>BiFunction</code> ，作用与 <code>Function</code>一样，只不过 <code>BiFunction</code> 可以接受两个参数，而 <code>Function</code> 只能接受一个参数。</p>
<p><code>thenAcceptBoth</code> 方法核心参数<code>BiConsumer</code> 作用也与 <code>Consumer</code>一样，不过其需要接受两个参数。</p>
<p><code>runAfterBoth</code> 方法核心参数最简单，上面已经介绍过，不再介绍。</p>
<p>这三组方法只能完成两个任务 AND 汇聚关系，如果需要完成多个任务汇聚关系，需要使用 <code>CompletableFuture#allOf</code>，不过这里需要注意，这个方法是不支持返回任务结果。</p>
<p>AND 汇聚关系相关示例代码，开头已经使用过了，这里再粘贴一下，方便大家理解：</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-c4cb12b1605a1b8c1b91c136837da417f75.JPEG" alt="img"></p>
<h3 id="1-7-OR-汇聚关系"><a href="#1-7-OR-汇聚关系" class="headerlink" title="1.7 OR 汇聚关系"></a>1.7 OR 汇聚关系</h3><p>有 AND 汇聚关系，当然也存在 OR 汇聚关系。OR 汇聚关系代表只要多个任务中任一任务完成，就可以接着接着执行下一任务。</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-8da70f24641d7538a203d3fa3dd8281bab3.JPEG" alt="img"></p>
<p><code>CompletionStage</code> 有以下接口描述这种关系：</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-d4ce05888ce7ba1fc854800a6004ddbf491.JPEG" alt="img"></p>
<p>前面三组接口方法传参与 AND 汇聚关系一致，这里也不再详细解释了。</p>
<p>当然 OR 汇聚关系可以使用 <code>CompletableFuture#anyOf</code> 执行多个任务。</p>
<p>下面示例代码展示如何使用 <code>applyToEither</code> 完成 OR 关系。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;String&gt; cf</span><br><span class="line">        = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    sleep(<span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello,楼下小黑哥&quot;</span>;</span><br><span class="line">&#125;);<span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line">CompletableFuture&lt;String&gt; cf2 = cf.supplyAsync(() -&gt; &#123;</span><br><span class="line">    sleep(<span class="number">3</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello，程序通事&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 执行 OR 关系</span></span><br><span class="line">CompletableFuture&lt;String&gt; cf3 = cf2.applyToEither(cf, s -&gt; s);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出结果，由于 cf2 只休眠 3 秒，优先执行完毕</span></span><br><span class="line">System.out.println(cf2.join());</span><br><span class="line"><span class="comment">// 结果：hello，程序通事</span></span><br></pre></td></tr></table></figure>

<h3 id="1-8-异常处理"><a href="#1-8-异常处理" class="headerlink" title="1.8 异常处理"></a>1.8 异常处理</h3><p><code>CompletableFuture</code> 方法执行过程若产生异常，当调用 <code>get</code>，<code>join </code>获取任务结果才会抛出异常。</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-9074887b6f23fe5c02e3066dfedf3312c2b.JPEG" alt="img"></p>
<p>上面代码我们显示使用 <code>try..catch</code> 处理上面的异常。不过这种方式不太优雅，<code>CompletionStage</code> 提供几个方法，可以优雅处理异常。</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-2fafa23a18cdd072aae9aab80c115462ad1.JPEG" alt="img"></p>
<p><code>exceptionally</code> 使用方式类似于 <code>try..catch</code> 中 <code>catch</code>代码块中异常处理。</p>
<p><code>whenComplete</code> 与 <code>handle</code> 方法就类似于 <code>try..catch..finanlly</code> 中 <code>finally</code> 代码块。无论是否发生异常，都将会执行的。这两个方法区别在于 <code>handle</code> 支持返回结果。</p>
<p>下面示例代码展示 <code>handle</code> 用法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;Integer&gt;</span><br><span class="line">        f0 = CompletableFuture.supplyAsync(() -&gt; (<span class="number">7</span> / <span class="number">0</span>))</span><br><span class="line">        .thenApply(r -&gt; r * <span class="number">10</span>)</span><br><span class="line">        .handle((integer, throwable) -&gt; &#123;</span><br><span class="line">            <span class="comment">// 如果异常存在,打印异常，并且返回默认值</span></span><br><span class="line">            <span class="keyword">if</span> (throwable != <span class="keyword">null</span>) &#123;</span><br><span class="line">                throwable.printStackTrace();</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 如果</span></span><br><span class="line">                <span class="keyword">return</span> integer;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">System.out.println(f0.join());</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *java.util.concurrent.CompletionException: java.lang.ArithmeticException: / by zero</span></span><br><span class="line"><span class="comment"> * .....</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 0</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<h2 id="0x02-总结"><a href="#0x02-总结" class="headerlink" title="0x02. 总结"></a>0x02. 总结</h2><p>JDK8 提供 <code>CompletableFuture</code> 功能非常强大，可以编排异步任务，完成串行执行，并行执行，AND 汇聚关系，OR 汇聚关系。</p>
<p>不过这个类方法实在太多，且方法还需要传入各种函数式接口，新手刚开始使用会直接会被弄懵逼。这里帮大家在总结一下三类核心参数的作用</p>
<ul>
<li><code>Function</code> 这类函数接口既支持接收参数，也支持返回值</li>
<li><code>Consumer</code> 这类接口函数只支持接受参数，不支持返回值</li>
<li><code>Runnable</code> 这类接口不支持接受参数，也不支持返回值</li>
</ul>
<p>搞清楚函数参数作用以后，然后根据串行，AND 汇聚关系，OR 汇聚关系归纳一下相关方法，这样就比较好理解了</p>
<p>最后再贴一下，文章开头的思维导图，希望对你有帮助。</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-e6932e814c7f276640f00f2a11666859bd3.JPEG" alt="img"></p>
<h2 id="0x03-帮助文档"><a href="#0x03-帮助文档" class="headerlink" title="0x03. 帮助文档"></a>0x03. 帮助文档</h2><ol>
<li>极客时间-并发编程专栏</li>
<li><a target="_blank" rel="noopener" href="https://colobu.com/2016/02/29/Java-CompletableFuture">https://colobu.com/2016/02/29/Java-CompletableFuture</a></li>
<li><a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/cn/java/j-cf-of-jdk8/index.html">https://www.ibm.com/developerworks/cn/java/j-cf-of-jdk8/index.html</a></li>
</ol>
<h2 id="最后说一句（求关注）"><a href="#最后说一句（求关注）" class="headerlink" title="最后说一句（求关注）"></a>最后说一句（求关注）</h2><p><code>CompletableFuture</code> 很早之前就有关注，本以为跟 <code>Future</code>一样，使用挺简单，谁知道学的时候才发现好难。各种 API 方法看的头有点大。</p>
<p>后来看到极客时间-『并发编程』专栏使用归纳方式分类 <code>CompletableFuture</code> 各种方法，一下子就看懂了。所这篇文章也参考这种归纳方式。</p>
<p>这篇文章找资料，整理一个星期，幸好今天顺利产出。</p>
<p>看在小黑哥写的这么辛苦的份上，点个关注吧，赏个赞呗。别下次一定啊，大哥！写文章很辛苦的，需要来点正反馈。</p>
<p>才疏学浅，难免会有纰漏，如果你发现了错误的地方，还请你留言给我指出来，我对其加以修改。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://veysky.github.io/blogOfLin/2020/11/16/%E7%BC%96%E7%A8%8B%E8%80%81%E5%8F%B8%E6%9C%BA%E5%B8%A6%E4%BD%A0%E7%8E%A9%E8%BD%AC-CompletableFuture-%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/" data-id="cklj6bnoy000xswn48sgn7dnp" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-电动车选购" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blogOfLin/2020/11/04/%E7%94%B5%E5%8A%A8%E8%BD%A6%E9%80%89%E8%B4%AD/" class="article-date">
  <time datetime="2020-11-04T05:51:32.000Z" itemprop="datePublished">2020-11-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blogOfLin/2020/11/04/%E7%94%B5%E5%8A%A8%E8%BD%A6%E9%80%89%E8%B4%AD/">电动车选购</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="选购指标"><a href="#选购指标" class="headerlink" title="选购指标"></a>选购指标</h3><ul>
<li>电机：好坏参考保修，无刷电机损耗小，寿命肯定更长。</li>
<li>刹车：碟刹优于鼓刹 ，同样价格下，有碟刹的更安全。</li>
<li>电池：锂电更轻，同样重量体积下，续航更久，充电更方便。</li>
<li>轮胎：尽量选择真空防扎轮胎，能大幅减低破胎概率，这点很实用。</li>
<li>工艺：如果线下购买，试驾测试下过隔离带的避震效果，如果是要散架的感觉那还是劝退吧。</li>
<li>车架：焊接处越少越好，单管车架最稳定最安全。</li>
</ul>
<h3 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">小叮当高配款出厂名为  小叮当新国标版，</span><br><span class="line">小叮当锂电升级版出厂名为 小轻新时尚版。</span><br><span class="line">小王子锂电版PLUS出厂名为 可可PLUS版。</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://veysky.github.io/blogOfLin/2020/11/04/%E7%94%B5%E5%8A%A8%E8%BD%A6%E9%80%89%E8%B4%AD/" data-id="cklj6bnoy000wswn41g4sgpok" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-解决无法删除状态为Dead的容器" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blogOfLin/2020/10/29/%E8%A7%A3%E5%86%B3%E6%97%A0%E6%B3%95%E5%88%A0%E9%99%A4%E7%8A%B6%E6%80%81%E4%B8%BADead%E7%9A%84%E5%AE%B9%E5%99%A8/" class="article-date">
  <time datetime="2020-10-29T12:58:22.000Z" itemprop="datePublished">2020-10-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blogOfLin/2020/10/29/%E8%A7%A3%E5%86%B3%E6%97%A0%E6%B3%95%E5%88%A0%E9%99%A4%E7%8A%B6%E6%80%81%E4%B8%BADead%E7%9A%84%E5%AE%B9%E5%99%A8/">解决无法删除状态为Dead的容器</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>简介：</strong> docker 强制删除（rm -f）container时出现错误提示 [root@Ieat1 ~]# docker rm -f nginx Error response from daemon: Driver devicemapper failed t…</p>
<p>docker 强制删除（rm -f）container时出现错误提示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@Ieat1 ~]# docker rm -f nginx</span><br><span class="line">Error response from daemon: Driver devicemapper failed to remove root filesystem a838d837988a593de3e997748cc80b1540dd31697f66e93dad275fbeaa5b3278: Device is Busy</span><br></pre></td></tr></table></figure>

<p>查看容器状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@Ieat1 ~]# docker ps -a|grep nginx</span><br><span class="line">a838d837988a        nginx                                                   &quot;nginx -g &#39;daemon ...&quot;   3 weeks ago         Dead </span><br></pre></td></tr></table></figure>

<p>发现它是 status为dead的容器，实际上，吞掉这个错误就可以了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker stop nginx 1&gt;&#x2F;dev&#x2F;null 2&gt;&amp;1 | exit 0</span><br><span class="line">docker rm -f nginx 1&gt;&#x2F;dev&#x2F;null 2&gt;&amp;1 | exit 0</span><br></pre></td></tr></table></figure>

<p>再次查看发现已经删除掉了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@Ieat1 ~]# docker ps -a|grep nginx</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://veysky.github.io/blogOfLin/2020/10/29/%E8%A7%A3%E5%86%B3%E6%97%A0%E6%B3%95%E5%88%A0%E9%99%A4%E7%8A%B6%E6%80%81%E4%B8%BADead%E7%9A%84%E5%AE%B9%E5%99%A8/" data-id="cklj6bnoz000yswn4gqasg3av" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-mermaid-flowchart-教程" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blogOfLin/2020/10/29/mermaid-flowchart-%E6%95%99%E7%A8%8B/" class="article-date">
  <time datetime="2020-10-29T11:41:27.000Z" itemprop="datePublished">2020-10-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blogOfLin/2020/10/29/mermaid-flowchart-%E6%95%99%E7%A8%8B/">mermaid-flowchart-教程</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Flowcharts-Basic-Syntax"><a href="#Flowcharts-Basic-Syntax" class="headerlink" title="Flowcharts - Basic Syntax"></a>Flowcharts - Basic Syntax</h1><p><a target="_blank" rel="noopener" href="https://mermaid-js.github.io/mermaid/diagrams-and-syntax-and-examples/flowchart.html">source</a></p>
<h2 id="Graph"><a href="#Graph" class="headerlink" title="Graph"></a>Graph</h2><p>This statement declares the direction of the Flowchart.</p>
<p>This declares the graph is oriented from top to bottom (<code>TD</code> or <code>TB</code>).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    Start --&gt; Stop</span><br></pre></td></tr></table></figure>

<p>StartStop</p>
<p>This declares the graph is oriented from left to right (<code>LR</code>).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    Start --&gt; Stop</span><br></pre></td></tr></table></figure>

<p>StartStop</p>
<h2 id="Flowchart-Orientation"><a href="#Flowchart-Orientation" class="headerlink" title="Flowchart Orientation"></a>Flowchart Orientation</h2><p>Possible FlowChart orientations are:</p>
<ul>
<li>TB - top to bottom</li>
<li>TD - top-down/ same as top to bottom</li>
<li>BT - bottom to top</li>
<li>RL - right to left</li>
<li>LR - left to right</li>
</ul>
<h2 id="Flowcharts"><a href="#Flowcharts" class="headerlink" title="Flowcharts"></a>Flowcharts</h2><p>This renders a flowchart that allows for features such as: more arrow types, multi directional arrows, and linking to and from subgraphs.</p>
<p>Apart from the graph type, the syntax is the same. This is currently experimental but when the beta period is over, both the graph and flowchart keywords will render in the new way. This means it is ok to start beta testing flowcharts.</p>
<blockquote>
<p><strong>Important note</strong> Do not type the word “end” as a Flowchart node. Capitalize all or any one the letters to keep the flowchart from breaking, i.e, “End” or “END”. Or you can apply this <a target="_blank" rel="noopener" href="https://github.com/mermaid-js/mermaid/issues/1444#issuecomment-639528897">workaround</a>.**</p>
</blockquote>
<h2 id="Nodes-amp-shapes"><a href="#Nodes-amp-shapes" class="headerlink" title="Nodes &amp; shapes"></a>Nodes &amp; shapes</h2><h3 id="A-node-default"><a href="#A-node-default" class="headerlink" title="A node (default)"></a>A node (default)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    id</span><br></pre></td></tr></table></figure>

<p>id</p>
<blockquote>
<p><strong>Note</strong> The id is what is displayed in the box.</p>
</blockquote>
<h3 id="A-node-with-text"><a href="#A-node-with-text" class="headerlink" title="A node with text"></a>A node with text</h3><p>It is also possible to set text in the box that differs from the id. If this is done several times, it is the last text found for the node that will be used. Also if you define edges for the node later on, you can omit text definitions. The one previously defined will be used when rendering the box.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    id1[This is the text in the box]</span><br></pre></td></tr></table></figure>

<p>This is the text in the box</p>
<h2 id="Node-Shapes"><a href="#Node-Shapes" class="headerlink" title="Node Shapes"></a>Node Shapes</h2><h3 id="A-node-with-round-edges"><a href="#A-node-with-round-edges" class="headerlink" title="A node with round edges"></a>A node with round edges</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    id1(This is the text in the box)</span><br></pre></td></tr></table></figure>

<p>This is the text in the box</p>
<h3 id="A-stadium-shaped-node"><a href="#A-stadium-shaped-node" class="headerlink" title="A stadium-shaped node"></a>A stadium-shaped node</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    id1([This is the text in the box])</span><br></pre></td></tr></table></figure>

<p>This is the text in the box</p>
<h3 id="A-node-in-a-subroutine-shape"><a href="#A-node-in-a-subroutine-shape" class="headerlink" title="A node in a subroutine shape"></a>A node in a subroutine shape</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    id1[[This is the text in the box]]</span><br></pre></td></tr></table></figure>

<p>This is the text in the box</p>
<h3 id="A-node-in-a-cylindrical-shape"><a href="#A-node-in-a-cylindrical-shape" class="headerlink" title="A node in a cylindrical shape"></a>A node in a cylindrical shape</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    id1[(Database)]</span><br></pre></td></tr></table></figure>

<p>Database</p>
<h3 id="A-node-in-the-form-of-a-circle"><a href="#A-node-in-the-form-of-a-circle" class="headerlink" title="A node in the form of a circle"></a>A node in the form of a circle</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    id1((This is the text in the circle))</span><br></pre></td></tr></table></figure>

<p>This is the text in the circle</p>
<h3 id="A-node-in-an-asymetric-shape"><a href="#A-node-in-an-asymetric-shape" class="headerlink" title="A node in an asymetric shape"></a>A node in an asymetric shape</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    id1&gt;This is the text in the box]</span><br></pre></td></tr></table></figure>

<p>This is the text in the box</p>
<p>Currently only the shape above is possible and not its mirror. <em>This might change with future releases.</em></p>
<h3 id="A-node-rhombus"><a href="#A-node-rhombus" class="headerlink" title="A node (rhombus)"></a>A node (rhombus)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    id1&#123;This is the text in the box&#125;</span><br></pre></td></tr></table></figure>

<p>This is the text in the box</p>
<h3 id="A-hexagon-node"><a href="#A-hexagon-node" class="headerlink" title="A hexagon node"></a>A hexagon node</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    id1&#123;&#123;This is the text in the box&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>This is the text in the box</p>
<h3 id="Parallelogram"><a href="#Parallelogram" class="headerlink" title="Parallelogram"></a>Parallelogram</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    id1[&#x2F;This is the text in the box&#x2F;]</span><br></pre></td></tr></table></figure>

<p>This is the text in the box</p>
<h3 id="Parallelogram-alt"><a href="#Parallelogram-alt" class="headerlink" title="Parallelogram alt"></a>Parallelogram alt</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    id1[\This is the text in the box\]</span><br></pre></td></tr></table></figure>

<p>This is the text in the box</p>
<h3 id="Trapezoid"><a href="#Trapezoid" class="headerlink" title="Trapezoid"></a>Trapezoid</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[&#x2F;Christmas\]</span><br></pre></td></tr></table></figure>

<p>Christmas</p>
<h3 id="Trapezoid-alt"><a href="#Trapezoid-alt" class="headerlink" title="Trapezoid alt"></a>Trapezoid alt</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    B[\Go shopping&#x2F;]</span><br></pre></td></tr></table></figure>

<p>Go shopping</p>
<h2 id="Links-between-nodes"><a href="#Links-between-nodes" class="headerlink" title="Links between nodes"></a>Links between nodes</h2><p>Nodes can be connected with links/edges. It is possible to have different types of links or attach a text string to a link.</p>
<h3 id="A-link-with-arrow-head"><a href="#A-link-with-arrow-head" class="headerlink" title="A link with arrow head"></a>A link with arrow head</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    A--&gt;B</span><br></pre></td></tr></table></figure>

<p>AB</p>
<h3 id="An-open-link"><a href="#An-open-link" class="headerlink" title="An open link"></a>An open link</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    A --- B</span><br></pre></td></tr></table></figure>

<p>AB</p>
<h3 id="Text-on-links"><a href="#Text-on-links" class="headerlink" title="Text on links"></a>Text on links</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    A-- This is the text! ---B</span><br></pre></td></tr></table></figure>

<p>This is the textAB</p>
<p>or</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    A---|This is the text|B</span><br></pre></td></tr></table></figure>

<p>This is the textAB</p>
<h3 id="A-link-with-arrow-head-and-text"><a href="#A-link-with-arrow-head-and-text" class="headerlink" title="A link with arrow head and text"></a>A link with arrow head and text</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    A--&gt;|text|B</span><br></pre></td></tr></table></figure>

<p>textAB</p>
<p>or</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    A-- text --&gt;B</span><br></pre></td></tr></table></figure>

<p>textAB</p>
<h3 id="Dotted-link"><a href="#Dotted-link" class="headerlink" title="Dotted link"></a>Dotted link</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR;</span><br><span class="line">   A-.-&gt;B;</span><br></pre></td></tr></table></figure>

<p>AB</p>
<h3 id="Dotted-link-with-text"><a href="#Dotted-link-with-text" class="headerlink" title="Dotted link with text"></a>Dotted link with text</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">   A-. text .-&gt; B</span><br></pre></td></tr></table></figure>

<p>textAB</p>
<h3 id="Thick-link"><a href="#Thick-link" class="headerlink" title="Thick link"></a>Thick link</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">   A &#x3D;&#x3D;&gt; B</span><br></pre></td></tr></table></figure>

<p>AB</p>
<h3 id="Thick-link-with-text"><a href="#Thick-link-with-text" class="headerlink" title="Thick link with text"></a>Thick link with text</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">   A &#x3D;&#x3D; text &#x3D;&#x3D;&gt; B</span><br></pre></td></tr></table></figure>

<p>textAB</p>
<h3 id="Chaining-of-links"><a href="#Chaining-of-links" class="headerlink" title="Chaining of links"></a>Chaining of links</h3><p>It is possible declare many links in the same line as per below:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">   A -- text --&gt; B -- text2 --&gt; C</span><br></pre></td></tr></table></figure>

<p>texttext2ABC</p>
<p>It is also possible to declare multiple nodes links in the same line as per below:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">   a --&gt; b &amp; c--&gt; d</span><br></pre></td></tr></table></figure>

<p>abcd</p>
<p>You can then describe dependencies in a very expressive way. Like the one-liner below:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line">    A &amp; B--&gt; C &amp; D</span><br></pre></td></tr></table></figure>

<p>ABCD</p>
<p>If you describe the same diagram using the the basic syntax, it will take four lines. A word of warning, one could go overboard with this making the graph harder to read in markdown form. The Swedish word <code>lagom</code> comes to mind. It means, not too much and not too little. This goes for expressive syntaxes as well.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line">    A --&gt; C</span><br><span class="line">    A --&gt; D</span><br><span class="line">    B --&gt; C</span><br><span class="line">    B --&gt; D</span><br></pre></td></tr></table></figure>

<h3 id="Beta-New-arrow-types"><a href="#Beta-New-arrow-types" class="headerlink" title="Beta: New arrow types"></a>Beta: New arrow types</h3><p>When using flowchart instead of graph there are new types of arrows supported as per below:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">flowchart LR</span><br><span class="line">    A --o B</span><br><span class="line">    B --x C</span><br></pre></td></tr></table></figure>

<p>ABC</p>
<h3 id="Beta-Multi-directional-arrows"><a href="#Beta-Multi-directional-arrows" class="headerlink" title="Beta: Multi directional arrows"></a>Beta: Multi directional arrows</h3><p>When using flowchart instead of graph there is the possibility to use multidirectional arrows.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">flowchart LR</span><br><span class="line">    A o--o B</span><br><span class="line">    B &lt;--&gt; C</span><br><span class="line">    C x--x D</span><br></pre></td></tr></table></figure>

<p>ABCD</p>
<h3 id="Minimum-length-of-a-link"><a href="#Minimum-length-of-a-link" class="headerlink" title="Minimum length of a link"></a>Minimum length of a link</h3><p>Each node in the flowchart is ultimately assigned to a rank in the rendered graph, i.e. to a vertical or horizontal level (depending on the flowchart orientation), based on the nodes to which it is linked. By default, links can span any number of ranks, but you can ask for any link to be longer than the others by adding extra dashes in the link definition.</p>
<p>In the following example, two extra dashes are added in the link from node <em>B</em> to node <em>E</em>, so that it spans two more ranks than regular links:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[Start] --&gt; B&#123;Is it?&#125;;</span><br><span class="line">    B --&gt;|Yes| C[OK];</span><br><span class="line">    C --&gt; D[Rethink];</span><br><span class="line">    D --&gt; B;</span><br><span class="line">    B ----&gt;|No| E[End];</span><br></pre></td></tr></table></figure>

<p>YesNoStartIs it?OKRethinkEnd</p>
<blockquote>
<p><strong>Note</strong> Links may still be made longer than the requested number of ranks by the rendering engine to accommodate other requests.</p>
</blockquote>
<p>When the link label is written in the middle of the link, the extra dashes must be added on the right side of the link. The following example is equivalent to the previous one:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[Start] --&gt; B&#123;Is it?&#125;;</span><br><span class="line">    B -- Yes --&gt; C[OK];</span><br><span class="line">    C --&gt; D[Rethink];</span><br><span class="line">    D --&gt; B;</span><br><span class="line">    B -- No ----&gt; E[End];</span><br></pre></td></tr></table></figure>

<p>YesNoStartIs it?OKRethinkEnd</p>
<p>For dotted or thick links, the characters to add are equals signs or dots, as summed up in the following table:</p>
<table>
<thead>
<tr>
<th>Length</th>
<th align="center">1</th>
<th align="center">2</th>
<th align="center">3</th>
</tr>
</thead>
<tbody><tr>
<td>Normal</td>
<td align="center"><code>---</code></td>
<td align="center"><code>----</code></td>
<td align="center"><code>-----</code></td>
</tr>
<tr>
<td>Normal with arrow</td>
<td align="center"><code>--&gt;</code></td>
<td align="center"><code>---&gt;</code></td>
<td align="center"><code>----&gt;</code></td>
</tr>
<tr>
<td>Thick</td>
<td align="center"><code>===</code></td>
<td align="center"><code>====</code></td>
<td align="center"><code>=====</code></td>
</tr>
<tr>
<td>Thick with arrow</td>
<td align="center"><code>==&gt;</code></td>
<td align="center"><code>===&gt;</code></td>
<td align="center"><code>====&gt;</code></td>
</tr>
<tr>
<td>Dotted</td>
<td align="center"><code>-.-</code></td>
<td align="center"><code>-..-</code></td>
<td align="center"><code>-...-</code></td>
</tr>
<tr>
<td>Dotted with arrow</td>
<td align="center"><code>-.-&gt;</code></td>
<td align="center"><code>-..-&gt;</code></td>
<td align="center"><code>-...-&gt;</code></td>
</tr>
</tbody></table>
<h2 id="Special-characters-that-break-syntax"><a href="#Special-characters-that-break-syntax" class="headerlink" title="Special characters that break syntax"></a>Special characters that break syntax</h2><p>It is possible to put text within quotes in order to render more troublesome characters. As in the example below:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    id1[&quot;This is the (text) in the box&quot;]</span><br></pre></td></tr></table></figure>

<p>This is the (text) in the box</p>
<h3 id="Entity-codes-to-escape-characters"><a href="#Entity-codes-to-escape-characters" class="headerlink" title="Entity codes to escape characters"></a>Entity codes to escape characters</h3><p>It is possible to escape characters using the syntax examplified here.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    A[&quot;A double quote:#quot;&quot;] --&gt;B[&quot;A dec char:#9829;&quot;]</span><br></pre></td></tr></table></figure>

<p>A double quote:”A dec char:♥</p>
<h2 id="Subgraphs"><a href="#Subgraphs" class="headerlink" title="Subgraphs"></a>Subgraphs</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">subgraph title</span><br><span class="line">    graph definition</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>An example below:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line">    c1--&gt;a2</span><br><span class="line">    subgraph one</span><br><span class="line">    a1--&gt;a2</span><br><span class="line">    end</span><br><span class="line">    subgraph two</span><br><span class="line">    b1--&gt;b2</span><br><span class="line">    end</span><br><span class="line">    subgraph three</span><br><span class="line">    c1--&gt;c2</span><br><span class="line">    end</span><br></pre></td></tr></table></figure>

<p>threetwoonec2c1b2b1a2a1</p>
<p>You can also set an excplicit id for the subgraph.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line">    c1--&gt;a2</span><br><span class="line">    subgraph ide1 [one]</span><br><span class="line">    a1--&gt;a2</span><br><span class="line">    end</span><br></pre></td></tr></table></figure>

<p>onea2a1c1</p>
<h2 id="Beta-flowcharts"><a href="#Beta-flowcharts" class="headerlink" title="Beta: flowcharts"></a>Beta: flowcharts</h2><p>With the graphtype flowcharts it is also possible to set edges to and from subgraphs as in the graph below.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">flowchart TB</span><br><span class="line">    c1--&gt;a2</span><br><span class="line">    subgraph one</span><br><span class="line">    a1--&gt;a2</span><br><span class="line">    end</span><br><span class="line">    subgraph two</span><br><span class="line">    b1--&gt;b2</span><br><span class="line">    end</span><br><span class="line">    subgraph three</span><br><span class="line">    c1--&gt;c2</span><br><span class="line">    end</span><br><span class="line">    one --&gt; two</span><br><span class="line">    three --&gt; two</span><br><span class="line">    two --&gt; c2</span><br></pre></td></tr></table></figure>

<p>threeonec2c1twob2b1a2a1</p>
<h2 id="Interaction"><a href="#Interaction" class="headerlink" title="Interaction"></a>Interaction</h2><p>It is possible to bind a click event to a node, the click can lead to either a javascript callback or to a link which will be opened in a new browser tab. <strong>Note</strong>: This functionality is disabled when using <code>securityLevel=&#39;strict&#39;</code> and enabled when using <code>securityLevel=&#39;loose&#39;</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">click nodeId callback</span><br></pre></td></tr></table></figure>

<ul>
<li>nodeId is the id of the node</li>
<li>callback is the name of a javascript function defined on the page displaying the graph, the function will be called with the nodeId as parameter.</li>
</ul>
<p>Examples of tooltip usage below:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">  var callback &#x3D; function()&#123;</span><br><span class="line">      alert(&#39;A callback was triggered&#39;);</span><br><span class="line">  &#125;</span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line">graph LR;</span><br><span class="line">    A--&gt;B;</span><br><span class="line">    click A callback &quot;Tooltip for a callback&quot;</span><br><span class="line">    click B &quot;http:&#x2F;&#x2F;www.github.com&quot; &quot;This is a tooltip for a link&quot;</span><br></pre></td></tr></table></figure>

<p>The tooltip text is surrounded in double quotes. The styles of the tooltip are set by the class .mermaidTooltip.</p>
<p>A<a target="_blank" rel="noopener" href="http://www.github.com/">B</a></p>
<blockquote>
<p><strong>Success</strong> The tooltip functionality and the ability to link to urls are available from version 0.5.2.</p>
</blockquote>
<p>?&gt; Due to limitations with how Docsify handles JavaScript callback functions, an alternate working demo for the above code can be viewed at <a target="_blank" rel="noopener" href="https://jsfiddle.net/s37cjoau/3/">this jsfiddle</a>.</p>
<p>Links are opened in the same browser tab/window by default. It is possible to change this by adding a link target to the click definition (<code>_self</code>, <code>_blank</code>, <code>_parent</code> and <code>_top</code> are supported):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">graph LR;</span><br><span class="line">    A--&gt;B;</span><br><span class="line">    B--&gt;C;</span><br><span class="line">    click A &quot;http:&#x2F;&#x2F;www.github.com&quot; </span><br><span class="line">    click B &quot;http:&#x2F;&#x2F;www.github.com&quot; &quot;Open this in a new tab&quot; _blank</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://www.github.com/">A</a><a target="_blank" rel="noopener" href="http://www.github.com/">B</a>C</p>
<p>Beginners tip, a full example using interactive links in a html context:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;div class&#x3D;&quot;mermaid&quot;&gt;</span><br><span class="line">    graph LR;</span><br><span class="line">        A--&gt;B;</span><br><span class="line">        click A callback &quot;Tooltip&quot;</span><br><span class="line">        click B &quot;http:&#x2F;&#x2F;www.github.com&quot; &quot;This is a link&quot;</span><br><span class="line">  &lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">  &lt;script&gt;</span><br><span class="line">    var callback &#x3D; function()&#123;</span><br><span class="line">        alert(&#39;A callback was triggered&#39;);</span><br><span class="line">    &#125;</span><br><span class="line">    var config &#x3D; &#123;</span><br><span class="line">        startOnLoad:true,</span><br><span class="line">        flowchart:&#123;</span><br><span class="line">            useMaxWidth:true,</span><br><span class="line">            htmlLabels:true,</span><br><span class="line">            curve:&#39;cardinal&#39;,</span><br><span class="line">        &#125;,</span><br><span class="line">        securityLevel:&#39;loose&#39;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    mermaid.initialize(config);</span><br><span class="line">  &lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Comments"><a href="#Comments" class="headerlink" title="Comments"></a>Comments</h3><p>Comments can be entered within a flow diagram, which will be ignored by the parser. Comments need to be on their own line, and must be prefaced with <code>%%</code> (double percent signs). Any text after the start of the comment to the next newline will be treated as a comment, including any flow syntax</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">%% this is a comment A -- text --&gt; B&#123;node&#125;</span><br><span class="line">   A -- text --&gt; B -- text2 --&gt; C</span><br></pre></td></tr></table></figure>

<h2 id="Styling-and-classes"><a href="#Styling-and-classes" class="headerlink" title="Styling and classes"></a>Styling and classes</h2><h3 id="Styling-links"><a href="#Styling-links" class="headerlink" title="Styling links"></a>Styling links</h3><p>It is possible to style links. For instance you might want to style a link that is going backwards in the flow. As links have no ids in the same way as nodes, some other way of deciding what style the links should be attached to is required. Instead of ids, the order number of when the link was defined in the graph is used. In the example below the style defined in the linkStyle statement will belong to the fourth link in the graph:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">linkStyle 3 stroke:#ff3,stroke-width:4px,color:red;</span><br></pre></td></tr></table></figure>

<h3 id="Styling-a-node"><a href="#Styling-a-node" class="headerlink" title="Styling a node"></a>Styling a node</h3><p>It is possible to apply specific styles such as a thicker border or a different background color to a node.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    id1(Start)--&gt;id2(Stop)</span><br><span class="line">    style id1 fill:#f9f,stroke:#333,stroke-width:4px</span><br><span class="line">    style id2 fill:#bbf,stroke:#f66,stroke-width:2px,color:#fff,stroke-dasharray: 5 5</span><br></pre></td></tr></table></figure>

<p>StartStop</p>
<h4 id="Classes"><a href="#Classes" class="headerlink" title="Classes"></a>Classes</h4><p>More convenient then defining the style every time is to define a class of styles and attach this class to the nodes that should have a different look.</p>
<p>a class definition looks like the example below:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">classDef className fill:#f9f,stroke:#333,stroke-width:4px;</span><br></pre></td></tr></table></figure>

<p>Attachment of a class to a node is done as per below:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">class nodeId1 className;</span><br></pre></td></tr></table></figure>

<p>It is also possible to attach a class to a list of nodes in one statement:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">class nodeId1,nodeId2 className;</span><br></pre></td></tr></table></figure>

<p>A shorter form of adding a class is to attach the classname to the node using the <code>:::</code>operator as per below:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    A:::someclass --&gt; B</span><br><span class="line">    classDef someclass fill:#f96;</span><br></pre></td></tr></table></figure>

<p>AB</p>
<h3 id="Css-classes"><a href="#Css-classes" class="headerlink" title="Css classes"></a>Css classes</h3><p>It is also possible to predefine classes in css styles that can be applied from the graph definition as in the example below:</p>
<p><strong>Example style</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;style&gt;</span><br><span class="line">    .cssClass &gt; rect&#123;</span><br><span class="line">        fill:#FF0000;</span><br><span class="line">        stroke:#FFFF00;</span><br><span class="line">        stroke-width:4px;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;&#x2F;style&gt;</span><br></pre></td></tr></table></figure>

<p><strong>Example definition</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">graph LR;</span><br><span class="line">    A--&gt;B[AAA&lt;span&gt;BBB&lt;&#x2F;span&gt;];</span><br><span class="line">    B--&gt;D;</span><br><span class="line">    class A cssClass;</span><br></pre></td></tr></table></figure>

<p>AAAA<span>BBB</span>D</p>
<h3 id="Default-class"><a href="#Default-class" class="headerlink" title="Default class"></a>Default class</h3><p>If a class is named default it will be assigned to all classes without specific class definitions.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">classDef default fill:#f9f,stroke:#333,stroke-width:4px;</span><br></pre></td></tr></table></figure>

<h2 id="Basic-support-for-fontawesome"><a href="#Basic-support-for-fontawesome" class="headerlink" title="Basic support for fontawesome"></a>Basic support for fontawesome</h2><p>It is possible to add icons from fontawesome.</p>
<p>The icons are acessed via the syntax fa:#icon class name#.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    B[&quot;fa:fa-twitter for peace&quot;]</span><br><span class="line">    B--&gt;C[fa:fa-ban forbidden]</span><br><span class="line">    B--&gt;D(fa:fa-spinner);</span><br><span class="line">    B--&gt;E(A fa:fa-camera-retro perhaps?);</span><br></pre></td></tr></table></figure>

<p> for peace forbiddenA perhaps?</p>
<h2 id="Graph-declarations-with-spaces-between-vertices-and-link-and-without-semicolon"><a href="#Graph-declarations-with-spaces-between-vertices-and-link-and-without-semicolon" class="headerlink" title="Graph declarations with spaces between vertices and link and without semicolon"></a>Graph declarations with spaces between vertices and link and without semicolon</h2><ul>
<li>In graph declarations, the statements also can now end without a semicolon. After release 0.2.16, ending a graph statement with semicolon is just optional. So the below graph declaration is also valid along with the old declarations of the graph.</li>
<li>A single space is allowed between vertices and the link. However there should not be any space between a vertex and its text and a link and its text. The old syntax of graph declaration will also work and hence this new feature is optional and is introduce to improve readability.</li>
</ul>
<p>Below is the new declaration of the graph edges which is also valid along with the old declaration of the graph edges.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    A[Hard edge] --&gt;|Link text| B(Round edge)</span><br><span class="line">    B --&gt; C&#123;Decision&#125;</span><br><span class="line">    C --&gt;|One| D[Result one]</span><br><span class="line">    C --&gt;|Two| E[Result two]</span><br></pre></td></tr></table></figure>

<p>Link textOneTwoHard edgeRound edgeDecisionResult oneResult two</p>
<h2 id="Configuration…"><a href="#Configuration…" class="headerlink" title="Configuration…"></a>Configuration…</h2><p>Is it possible to adjust the width of the rendered flowchart.</p>
<p>This is done by defining <strong>mermaid.flowchartConfig</strong> or by the CLI to use a json file with the configuration. How to use the CLI is described in the mermaidCLI page. mermaid.flowchartConfig can be set to a JSON string with config parameters or the corresponding object.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mermaid.flowchartConfig &#x3D; &#123;</span><br><span class="line">    width: 100%</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://veysky.github.io/blogOfLin/2020/10/29/mermaid-flowchart-%E6%95%99%E7%A8%8B/" data-id="cklj6bnor000oswn48uwd6sod" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-sonar-install" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blogOfLin/2020/10/20/sonar-install/" class="article-date">
  <time datetime="2020-10-20T12:57:37.000Z" itemprop="datePublished">2020-10-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blogOfLin/2020/10/20/sonar-install/">sonar install</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>SonarQube的LTS版本以6.7和7.9较为具有代表性，这篇文章整理了一下SonarQube LTS 6.7.1 + MySQL的环境搭建方式。</p>
<h1 id="SonarQube-6-7-1"><a href="#SonarQube-6-7-1" class="headerlink" title="SonarQube 6.7.1"></a>SonarQube 6.7.1</h1><p>这里使用Alpine版本的SonarQube 6.7.1和MySQL 5.7.16进行环境搭建，docker-compose.yml如下所示</p>
<h2 id="docker-compose-yml文件"><a href="#docker-compose-yml文件" class="headerlink" title="docker-compose.yml文件"></a>docker-compose.yml文件</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">liumiaocn:sonar</span> <span class="string">liumiao$</span> <span class="string">cat</span> <span class="string">docker-compose.6.7.yml</span> </span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;2&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="comment"># database service: mysql</span></span><br><span class="line">  <span class="attr">mysql:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">liumiaocn/mysql:5.7.16</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3306:3306&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./mysql/data/:/var/lib/mysql</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./mysql/conf.d/:/etc/mysql/conf.d</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_ROOT_PASSWORD=hello123</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_DATABASE=sonarqube</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">&quot;no&quot;</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">  <span class="comment"># Security service: sonarqube</span></span><br><span class="line">  <span class="attr">sonarqube:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">liumiaocn/sonarqube:6.7.1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9000:9000&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./sonar/data/:/opt/sonarqube/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./sonar/log/:/opt/sonarqube/log</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./sonar/extensions/:/opt/sonarqube/extensions</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./sonar/conf/:/opt/sonarqube/conf</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SONARQUBE_JDBC_USERNAME=root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SONARQUBE_JDBC_PASSWORD=hello123</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SONARQUBE_JDBC_URL=jdbc:mysql://mysql:3306/sonarqube?useUnicode=true&amp;characterEncoding=utf8&amp;rewriteBatchedStatements=true&amp;useConfigs=maxPerformance</span></span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql:mysql</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">&quot;no&quot;</span></span><br><span class="line"><span class="string">liumiaocn:sonar</span> <span class="string">liumiao$</span> </span><br><span class="line"><span class="number">1234567891011121314151617181920212223242526272829303132333435363738</span></span><br></pre></td></tr></table></figure>

<h2 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">liumiaocn:sonar liumiao$ docker-compose -f docker-compose.6.7.yml up -d</span><br><span class="line">Creating sonar_mysql_1 ... done</span><br><span class="line">Creating sonar_sonarqube_1 ... done</span><br><span class="line">liumiaocn:sonar liumiao$ </span><br><span class="line">1234</span><br></pre></td></tr></table></figure>

<h2 id="结果确认"><a href="#结果确认" class="headerlink" title="结果确认"></a>结果确认</h2><p>docker容器启动之后，可以使用docker-compose ps命令确认服务运行状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">liumiaocn:sonar liumiao$ docker-compose -f docker-compose.6.7.yml ps</span><br><span class="line">      Name                    Command             State           Ports         </span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">sonar_mysql_1       docker-entrypoint.sh mysqld   Up      0.0.0.0:3306-&gt;3306&#x2F;tcp</span><br><span class="line">sonar_sonarqube_1   .&#x2F;bin&#x2F;run.sh                  Up      0.0.0.0:9000-&gt;9000&#x2F;tcp</span><br><span class="line">liumiaocn:sonar liumiao$ </span><br><span class="line">123456</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/2019102221475894.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20191022214809346.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saXVtaWFvY24uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h1 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h1><p>使用示例可参看：<br><a target="_blank" rel="noopener" href="https://liumiaocn.blog.csdn.net/article/details/102670480">Angular应用中使用SonarQube进行质量扫描</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://veysky.github.io/blogOfLin/2020/10/20/sonar-install/" data-id="cklj6bnov000sswn48rvuc683" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-local-test-zookeeper" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blogOfLin/2020/10/16/local-test-zookeeper/" class="article-date">
  <time datetime="2020-10-16T13:52:55.000Z" itemprop="datePublished">2020-10-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blogOfLin/2020/10/16/local-test-zookeeper/">local test zookeeper</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id=""><a href="#" class="headerlink" title=""></a></h1><p>$ pwd<br>/root/workspace/apache-zookeeper-3.6.2-bin/bin</p>
<p>$ /bin/bash ./zkCli.sh -timeout 5000 -server  10.4.154.137:2181</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#docker 启动服务命令</span><br><span class="line">docker run -d -e TZ&#x3D;&quot;Asia&#x2F;Shanghai&quot; -p 8080:2181 -v $PWD&#x2F;data:&#x2F;data --name zookeeper --restart always zookeeper</span><br><span class="line">#docker client 启动 zookeeper 测试    </span><br><span class="line">docker run -it --rm --link zookeeper:zookeeper zookeeper zkCli.sh -server zookeeper</span><br></pre></td></tr></table></figure>






      
    </div>
    <footer class="article-footer">
      <a data-url="https://veysky.github.io/blogOfLin/2020/10/16/local-test-zookeeper/" data-id="cklj6bnor000mswn4ajya1y2f" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-ZooKeeper之zkCli-sh客户端命令使用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blogOfLin/2020/10/16/ZooKeeper%E4%B9%8BzkCli-sh%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%91%BD%E4%BB%A4%E4%BD%BF%E7%94%A8/" class="article-date">
  <time datetime="2020-10-16T13:04:46.000Z" itemprop="datePublished">2020-10-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blogOfLin/2020/10/16/ZooKeeper%E4%B9%8BzkCli-sh%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%91%BD%E4%BB%A4%E4%BD%BF%E7%94%A8/">ZooKeeper之zkCli.sh客户端命令使用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>zkCli.sh的使用</p>
<p>ZooKeeper服务器简历客户端</p>
<p>./zkCli.sh -timeout 0 -r -server ip:port</p>
<p>./zkCli.sh -timeout 5000 -server 192.9.200.242:2181</p>
<p>-r ：即使ZooKeeper服务器集群一般以上的服务器当掉，也给客户端体统读服务</p>
<p> <img src="https://images2015.cnblogs.com/blog/467583/201704/467583-20170412103432626-517212033.png" alt="img"></p>
<p>h  显示所有命令</p>
<p><img src="https://images2015.cnblogs.com/blog/467583/201704/467583-20170412103510657-353732916.png" alt="img"></p>
<p><img src="https://images2015.cnblogs.com/blog/467583/201704/467583-20170412103520657-1596875669.png" alt="img"></p>
<p>ls path:查看某个节点下的所有子节点信息</p>
<p>ls / :列出根节点下所有的子节点信息</p>
<p> <img src="https://images2015.cnblogs.com/blog/467583/201704/467583-20170412103633126-1652792339.png" alt="img"></p>
<p>stat path :获取指定节点的状态信息</p>
<p>状态信息分析：</p>
<p> <img src="https://images2015.cnblogs.com/blog/467583/201704/467583-20170412103641438-321625582.png" alt="img"></p>
<p>czxid 创建该节点的事物ID</p>
<p>ctime 创建该节点的时间</p>
<p>mZxid 更新该节点的事物ID</p>
<p>mtime 更新该节点的时间</p>
<p>pZxid 操作当前节点的子节点列表的事物ID(这种操作包含增加子节点，删除子节点)</p>
<p>cversion 当前节点的子节点版本号</p>
<p>dataVersion 当前节点的数据版本号</p>
<p>aclVersion 当前节点的acl权限版本号</p>
<p>ephemeralowner 当前节点的如果是临时节点，该属性是临时节点的事物ID</p>
<p>dataLength 当前节点的d的数据长度</p>
<p>numchildren 当前节点的子节点个数</p>
<p>get path 获取当前节点的数据内容</p>
<p> <img src="https://images2015.cnblogs.com/blog/467583/201704/467583-20170412103752407-284814014.png" alt="img"></p>
<p>ls2 path :是ls 和 stat两个命令的结合</p>
<p> <img src="https://images2015.cnblogs.com/blog/467583/201704/467583-20170412103803282-687553261.png" alt="img"></p>
<p>create [-s] [-e] path data acl</p>
<p>-s 表示是顺序节点</p>
<p>-e 标识是临时节点</p>
<p>path 节点路径</p>
<p>data 节点数据</p>
<p>acl 节点权限</p>
<p> <img src="https://images2015.cnblogs.com/blog/467583/201704/467583-20170412103812954-1661161404.png" alt="img"></p>
<p> 注：临时节点在客户端结束与服务器的会话后，自动消失</p>
<p>quit  :退出客户端</p>
<p>set path data [version] :修改当前节点的数据内容  如果指定版本，需要和当前节点的数据版本一致</p>
<p> <img src="https://images2015.cnblogs.com/blog/467583/201704/467583-20170412103938922-692019311.png" alt="img"></p>
<p>delete path [version] 删除指定路径的节点 如果有子节点要先删除子节点</p>
<p> <img src="https://images2015.cnblogs.com/blog/467583/201704/467583-20170412104051735-851248099.png" alt="img"></p>
<p>rmr path 删除当前路径节点及其所有子节点</p>
<p> <img src="https://images2015.cnblogs.com/blog/467583/201704/467583-20170412104105047-1158558352.png" alt="img"></p>
<p> setquota -n|-b val path 设置节点配额（比如限制节点数据长度，限制节点中子节点个数）</p>
<p>-n 是限制子节点个数 -b是限制节点数据长度</p>
<p>超出配额后，ZooKeeper不会报错，而是在日志信息中记录</p>
<p>tail zookeeper.out</p>
<p> <img src="https://images2015.cnblogs.com/blog/467583/201704/467583-20170412104113532-1061009424.png" alt="img"></p>
<p> <img src="https://images2015.cnblogs.com/blog/467583/201704/467583-20170412104123329-1203686067.png" alt="img"></p>
<p>listquota path 查看路径节点的配额信息</p>
<p> <img src="https://images2015.cnblogs.com/blog/467583/201704/467583-20170412104248672-1596926125.png" alt="img"></p>
<p>delquota [-n|-b] path 删除节点路径的配额信息  </p>
<p> <img src="https://images2015.cnblogs.com/blog/467583/201704/467583-20170412104300344-1454716102.png" alt="img"></p>
<p>connect host:port 和 clost</p>
<p>在当前连接中连接其他的ZooKeeper服务器和关闭服务器</p>
<p> <img src="https://images2015.cnblogs.com/blog/467583/201704/467583-20170412104309094-923966637.png" alt="img"></p>
<p>history 和 redo cmdno :查看客户端这次会话所执行的所有命令 和 执行指定历史命令</p>
<p> <img src="https://images2015.cnblogs.com/blog/467583/201704/467583-20170412104317360-1959917830.png" alt="img"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://veysky.github.io/blogOfLin/2020/10/16/ZooKeeper%E4%B9%8BzkCli-sh%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%91%BD%E4%BB%A4%E4%BD%BF%E7%94%A8/" data-id="cklj6bnok000bswn43ewu7xjn" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blogOfLin/tags/zkCli-sh-%E5%AE%A2%E6%88%B7%E7%AB%AF-%E5%91%BD%E4%BB%A4-ZooKeeper/" rel="tag">zkCli.sh, 客户端, 命令, ZooKeeper</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-zookeeper-客户端Curator使用详解" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blogOfLin/2020/10/16/zookeeper-%E5%AE%A2%E6%88%B7%E7%AB%AFCurator%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3/" class="article-date">
  <time datetime="2020-10-16T12:59:15.000Z" itemprop="datePublished">2020-10-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blogOfLin/2020/10/16/zookeeper-%E5%AE%A2%E6%88%B7%E7%AB%AFCurator%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3/">zookeeper 客户端Curator使用详解</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Curator是Netflix公司开源的一套zookeeper客户端框架，解决了很多Zookeeper客户端非常底层的细节开发工作，包括连接重连、反复注册Watcher和NodeExistsException异常等等。Patrixck Hunt（Zookeeper）以一句“Guava is to Java that Curator to Zookeeper”给Curator予高度评价。<br><strong>引子和趣闻：</strong><br>Zookeeper名字的由来是比较有趣的，下面的片段摘抄自《从PAXOS到ZOOKEEPER分布式一致性原理与实践》一书：<br>Zookeeper最早起源于雅虎的研究院的一个研究小组。在当时，研究人员发现，在雅虎内部很多大型的系统需要依赖一个类似的系统进行分布式协调，但是这些系统往往存在分布式单点问题。所以雅虎的开发人员就试图开发一个通用的无单点问题的分布式协调框架。在立项初期，考虑到很多项目都是用动物的名字来命名的(例如著名的Pig项目)，雅虎的工程师希望给这个项目也取一个动物的名字。时任研究院的首席科学家Raghu Ramakrishnan开玩笑说：再这样下去，我们这儿就变成动物园了。此话一出，大家纷纷表示就叫动物园管理员吧——因为各个以动物命名的分布式组件放在一起，雅虎的整个分布式系统看上去就像一个大型的动物园了，而Zookeeper正好用来进行分布式环境的协调——于是，Zookeeper的名字由此诞生了。</p>
<p>Curator无疑是Zookeeper客户端中的瑞士军刀，它译作”馆长”或者’’管理者’’，不知道是不是开发小组有意而为之，笔者猜测有可能这样命名的原因是说明Curator就是Zookeeper的馆长(脑洞有点大：Curator就是动物园的园长)。<br>Curator包含了几个包：<br><strong>curator-framework：</strong>对zookeeper的底层api的一些封装<br><strong>curator-client：</strong>提供一些客户端的操作，例如重试策略等<br><strong>curator-recipes：</strong>封装了一些高级特性，如：Cache事件监听、选举、分布式锁、分布式计数器、分布式Barrier等<br>Maven依赖(使用curator的版本：2.12.0，对应Zookeeper的版本为：3.4.x，<strong>如果跨版本会有兼容性问题，很有可能导致节点操作失败</strong>)：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.12.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-recipes<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.12.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="Curator的基本Api"><a href="#Curator的基本Api" class="headerlink" title="Curator的基本Api"></a>Curator的基本Api</h1><h2 id="创建会话"><a href="#创建会话" class="headerlink" title="创建会话"></a>创建会话</h2><h3 id="1-使用静态工程方法创建客户端"><a href="#1-使用静态工程方法创建客户端" class="headerlink" title="1.使用静态工程方法创建客户端"></a>1.使用静态工程方法创建客户端</h3><p>一个例子如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">RetryPolicy retryPolicy = <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">3</span>);</span><br><span class="line">CuratorFramework client =</span><br><span class="line">CuratorFrameworkFactory.newClient(</span><br><span class="line">                        connectionInfo,</span><br><span class="line">                        <span class="number">5000</span>,</span><br><span class="line">                        <span class="number">3000</span>,</span><br><span class="line">                        retryPolicy);</span><br></pre></td></tr></table></figure>

<p>newClient静态工厂方法包含四个主要参数：</p>
<table>
<thead>
<tr>
<th align="left">参数名</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">connectionString</td>
<td align="center">服务器列表，格式host1:port1,host2:port2,…</td>
</tr>
<tr>
<td align="left">retryPolicy</td>
<td align="center">重试策略,内建有四种重试策略,也可以自行实现RetryPolicy接口</td>
</tr>
<tr>
<td align="left">sessionTimeoutMs</td>
<td align="center">会话超时时间，单位毫秒，默认60000ms</td>
</tr>
<tr>
<td align="left">connectionTimeoutMs</td>
<td align="center">连接创建超时时间，单位毫秒，默认60000ms</td>
</tr>
</tbody></table>
<h3 id="2-使用Fluent风格的Api创建会话"><a href="#2-使用Fluent风格的Api创建会话" class="headerlink" title="2.使用Fluent风格的Api创建会话"></a>2.使用Fluent风格的Api创建会话</h3><p>核心参数变为流式设置，一个列子如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">RetryPolicy retryPolicy = <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">3</span>);</span><br><span class="line">CuratorFramework client =</span><br><span class="line">CuratorFrameworkFactory.builder()</span><br><span class="line">        .connectString(connectionInfo)</span><br><span class="line">        .sessionTimeoutMs(<span class="number">5000</span>)</span><br><span class="line">        .connectionTimeoutMs(<span class="number">5000</span>)</span><br><span class="line">        .retryPolicy(retryPolicy)</span><br><span class="line">        .build();</span><br></pre></td></tr></table></figure>

<h3 id="3-创建包含隔离命名空间的会话"><a href="#3-创建包含隔离命名空间的会话" class="headerlink" title="3.创建包含隔离命名空间的会话"></a>3.创建包含隔离命名空间的会话</h3><p>为了实现不同的Zookeeper业务之间的隔离，需要为每个业务分配一个独立的命名空间（<strong>NameSpace</strong>），即指定一个Zookeeper的根路径（官方术语：*<strong>为Zookeeper添加“Chroot”特性*</strong>）。例如（下面的例子）当客户端指定了独立命名空间为“/base”，那么该客户端对Zookeeper上的数据节点的操作都是基于该目录进行的。通过设置Chroot可以将客户端应用与Zookeeper服务端的一课子树相对应，在多个应用共用一个Zookeeper集群的场景下，这对于实现不同应用之间的相互隔离十分有意义。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">RetryPolicy retryPolicy = <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">3</span>);</span><br><span class="line">        CuratorFramework client =</span><br><span class="line">        CuratorFrameworkFactory.builder()</span><br><span class="line">                .connectString(connectionInfo)</span><br><span class="line">                .sessionTimeoutMs(<span class="number">5000</span>)</span><br><span class="line">                .connectionTimeoutMs(<span class="number">5000</span>)</span><br><span class="line">                .retryPolicy(retryPolicy)</span><br><span class="line">                .namespace(<span class="string">&quot;base&quot;</span>)</span><br><span class="line">                .build();</span><br></pre></td></tr></table></figure>

<h2 id="启动客户端"><a href="#启动客户端" class="headerlink" title="启动客户端"></a>启动客户端</h2><p>当创建会话成功，得到client的实例然后可以直接调用其start( )方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.start();</span><br></pre></td></tr></table></figure>

<h2 id="数据节点操作"><a href="#数据节点操作" class="headerlink" title="数据节点操作"></a>数据节点操作</h2><h3 id="创建数据节点"><a href="#创建数据节点" class="headerlink" title="创建数据节点"></a>创建数据节点</h3><p><strong>Zookeeper的节点创建模式：</strong></p>
<ul>
<li>PERSISTENT：持久化</li>
<li>PERSISTENT_SEQUENTIAL：持久化并且带序列号</li>
<li>EPHEMERAL：临时</li>
<li>EPHEMERAL_SEQUENTIAL：临时并且带序列号</li>
</ul>
<p>**创建一个节点，初始内容为空 **</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">client</span><span class="selector-class">.create</span>()<span class="selector-class">.forPath</span>(&quot;<span class="selector-tag">path</span>&quot;);</span><br></pre></td></tr></table></figure>

<p>注意：如果没有设置节点属性，节点创建模式默认为持久化节点，内容默认为空</p>
<p><strong>创建一个节点，附带初始化内容</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">client</span><span class="selector-class">.create</span>()<span class="selector-class">.forPath</span>(&quot;<span class="selector-tag">path</span>&quot;,&quot;<span class="selector-tag">init</span>&quot;<span class="selector-class">.getBytes</span>());</span><br></pre></td></tr></table></figure>

<p><strong>创建一个节点，指定创建模式（临时节点），内容为空</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">client</span><span class="selector-class">.create</span>()<span class="selector-class">.withMode</span>(<span class="selector-tag">CreateMode</span><span class="selector-class">.EPHEMERAL</span>)<span class="selector-class">.forPath</span>(&quot;<span class="selector-tag">path</span>&quot;);</span><br></pre></td></tr></table></figure>

<p><strong>创建一个节点，指定创建模式（临时节点），附带初始化内容</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">client</span><span class="selector-class">.create</span>()<span class="selector-class">.withMode</span>(<span class="selector-tag">CreateMode</span><span class="selector-class">.EPHEMERAL</span>)<span class="selector-class">.forPath</span>(&quot;<span class="selector-tag">path</span>&quot;,&quot;<span class="selector-tag">init</span>&quot;<span class="selector-class">.getBytes</span>());</span><br></pre></td></tr></table></figure>

<p><strong>创建一个节点，指定创建模式（临时节点），附带初始化内容，并且自动递归创建父节点</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">client.create()</span><br><span class="line">      .creatingParentContainersIfNeeded()</span><br><span class="line">      .withMode(CreateMode.EPHEMERAL)</span><br><span class="line">      .forPath(<span class="string">&quot;path&quot;</span>,<span class="string">&quot;init&quot;</span>.getBytes());</span><br></pre></td></tr></table></figure>

<p>这个creatingParentContainersIfNeeded()接口非常有用，因为一般情况开发人员在创建一个子节点必须判断它的父节点是否存在，如果不存在直接创建会抛出NoNodeException，使用creatingParentContainersIfNeeded()之后Curator能够自动递归创建所有所需的父节点。</p>
<h3 id="删除数据节点"><a href="#删除数据节点" class="headerlink" title="删除数据节点"></a>删除数据节点</h3><p><strong>删除一个节点</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.<span class="keyword">delete</span>().forPath(<span class="string">&quot;path&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>注意，此方法只能删除<strong>叶子节点</strong>，否则会抛出异常。</p>
<p><strong>删除一个节点，并且递归删除其所有的子节点</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">client</span><span class="selector-class">.delete</span>()<span class="selector-class">.deletingChildrenIfNeeded</span>()<span class="selector-class">.forPath</span>(&quot;<span class="selector-tag">path</span>&quot;);</span><br></pre></td></tr></table></figure>

<p><strong>删除一个节点，强制指定版本进行删除</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">client</span><span class="selector-class">.delete</span>()<span class="selector-class">.withVersion</span>(10086)<span class="selector-class">.forPath</span>(&quot;<span class="selector-tag">path</span>&quot;);</span><br></pre></td></tr></table></figure>

<p><strong>删除一个节点，强制保证删除</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">client</span><span class="selector-class">.delete</span>()<span class="selector-class">.guaranteed</span>()<span class="selector-class">.forPath</span>(&quot;<span class="selector-tag">path</span>&quot;);</span><br></pre></td></tr></table></figure>

<p>guaranteed()接口是一个保障措施，只要客户端会话有效，那么Curator会在后台持续进行删除操作，直到删除节点成功。</p>
<p><strong>注意：</strong>上面的多个流式接口是可以自由组合的，例如：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">client</span><span class="selector-class">.delete</span>()<span class="selector-class">.guaranteed</span>()<span class="selector-class">.deletingChildrenIfNeeded</span>()<span class="selector-class">.withVersion</span>(10086)<span class="selector-class">.forPath</span>(&quot;<span class="selector-tag">path</span>&quot;);</span><br></pre></td></tr></table></figure>

<h3 id="读取数据节点数据"><a href="#读取数据节点数据" class="headerlink" title="读取数据节点数据"></a>读取数据节点数据</h3><p><strong>读取一个节点的数据内容</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">client</span><span class="selector-class">.getData</span>()<span class="selector-class">.forPath</span>(&quot;<span class="selector-tag">path</span>&quot;);</span><br></pre></td></tr></table></figure>

<p>注意，此方法返的返回值是byte[ ];</p>
<p><strong>读取一个节点的数据内容，同时获取到该节点的stat</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Stat <span class="built_in">stat</span> = new Stat();</span><br><span class="line">client.getData().storingStatIn(<span class="built_in">stat</span>).forPath(<span class="string">&quot;path&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="更新数据节点数据"><a href="#更新数据节点数据" class="headerlink" title="更新数据节点数据"></a>更新数据节点数据</h3><p><strong>更新一个节点的数据内容</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">client</span><span class="selector-class">.setData</span>()<span class="selector-class">.forPath</span>(&quot;<span class="selector-tag">path</span>&quot;,&quot;<span class="selector-tag">data</span>&quot;<span class="selector-class">.getBytes</span>());</span><br></pre></td></tr></table></figure>

<p>注意：该接口会返回一个Stat实例</p>
<p><strong>更新一个节点的数据内容，强制指定版本进行更新</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">client</span><span class="selector-class">.setData</span>()<span class="selector-class">.withVersion</span>(10086)<span class="selector-class">.forPath</span>(&quot;<span class="selector-tag">path</span>&quot;,&quot;<span class="selector-tag">data</span>&quot;<span class="selector-class">.getBytes</span>());</span><br></pre></td></tr></table></figure>

<h3 id="检查节点是否存在"><a href="#检查节点是否存在" class="headerlink" title="检查节点是否存在"></a>检查节点是否存在</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">client</span><span class="selector-class">.checkExists</span>()<span class="selector-class">.forPath</span>(&quot;<span class="selector-tag">path</span>&quot;);</span><br></pre></td></tr></table></figure>

<p>注意：该方法返回一个Stat实例，用于检查ZNode是否存在的操作. 可以调用额外的方法(监控或者后台处理)并在最后调用forPath( )指定要操作的ZNode</p>
<h3 id="获取某个节点的所有子节点路径"><a href="#获取某个节点的所有子节点路径" class="headerlink" title="获取某个节点的所有子节点路径"></a>获取某个节点的所有子节点路径</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">client</span><span class="selector-class">.getChildren</span>()<span class="selector-class">.forPath</span>(&quot;<span class="selector-tag">path</span>&quot;);</span><br></pre></td></tr></table></figure>

<p>注意：该方法的返回值为List<String>,获得ZNode的子节点Path列表。 可以调用额外的方法(监控、后台处理或者获取状态watch, background or get stat) 并在最后调用forPath()指定要操作的父ZNode</p>
<h3 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h3><p>CuratorFramework的实例包含inTransaction( )接口方法，调用此方法开启一个ZooKeeper事务. 可以复合create, setData, check, and/or delete 等操作然后调用commit()作为一个原子操作提交。一个例子如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">client.inTransaction().check().forPath(<span class="string">&quot;path&quot;</span>)</span><br><span class="line">      .and()</span><br><span class="line">      .create().withMode(CreateMode.EPHEMERAL).forPath(<span class="string">&quot;path&quot;</span>,<span class="string">&quot;data&quot;</span>.getBytes())</span><br><span class="line">      .and()</span><br><span class="line">      .setData().withVersion(<span class="number">10086</span>).forPath(<span class="string">&quot;path&quot;</span>,<span class="string">&quot;data2&quot;</span>.getBytes())</span><br><span class="line">      .and()</span><br><span class="line">      .commit();</span><br></pre></td></tr></table></figure>

<h3 id="异步接口"><a href="#异步接口" class="headerlink" title="异步接口"></a>异步接口</h3><p>上面提到的创建、删除、更新、读取等方法都是同步的，Curator提供异步接口，引入了<strong>BackgroundCallback</strong>接口用于处理异步接口调用之后服务端返回的结果信息。<strong>BackgroundCallback</strong>接口中一个重要的回调值为CuratorEvent，里面包含事件类型、响应吗和节点的详细信息。</p>
<p><strong>CuratorEventType</strong></p>
<table>
<thead>
<tr>
<th align="center">事件类型</th>
<th align="center">对应CuratorFramework实例的方法</th>
</tr>
</thead>
<tbody><tr>
<td align="center">CREATE</td>
<td align="center">#create()</td>
</tr>
<tr>
<td align="center">DELETE</td>
<td align="center">#delete()</td>
</tr>
<tr>
<td align="center">EXISTS</td>
<td align="center">#checkExists()</td>
</tr>
<tr>
<td align="center">GET_DATA</td>
<td align="center">#getData()</td>
</tr>
<tr>
<td align="center">SET_DATA</td>
<td align="center">#setData()</td>
</tr>
<tr>
<td align="center">CHILDREN</td>
<td align="center">#getChildren()</td>
</tr>
<tr>
<td align="center">SYNC</td>
<td align="center">#sync(String,Object)</td>
</tr>
<tr>
<td align="center">GET_ACL</td>
<td align="center">#getACL()</td>
</tr>
<tr>
<td align="center">SET_ACL</td>
<td align="center">#setACL()</td>
</tr>
<tr>
<td align="center">WATCHED</td>
<td align="center">#Watcher(Watcher)</td>
</tr>
<tr>
<td align="center">CLOSING</td>
<td align="center">#close()</td>
</tr>
</tbody></table>
<p><strong>响应码(#getResultCode())</strong></p>
<table>
<thead>
<tr>
<th align="center">响应码</th>
<th align="center">意义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0</td>
<td align="center">OK，即调用成功</td>
</tr>
<tr>
<td align="center">-4</td>
<td align="center">ConnectionLoss，即客户端与服务端断开连接</td>
</tr>
<tr>
<td align="center">-110</td>
<td align="center">NodeExists，即节点已经存在</td>
</tr>
<tr>
<td align="center">-112</td>
<td align="center">SessionExpired，即会话过期</td>
</tr>
</tbody></table>
<p>一个异步创建节点的例子如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Executor executor = Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">client.create()</span><br><span class="line">      .creatingParentsIfNeeded()</span><br><span class="line">      .withMode(CreateMode.EPHEMERAL)</span><br><span class="line">      .inBackground((curatorFramework, curatorEvent) -&gt; &#123;      System.out.println(String.format(<span class="string">&quot;eventType:%s,resultCode:%s&quot;</span>,curatorEvent.getType(),curatorEvent.getResultCode()));</span><br><span class="line">      &#125;,executor)</span><br><span class="line">      .forPath(<span class="string">&quot;path&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>注意：如果#inBackground()方法不指定executor，那么会默认使用Curator的EventThread去进行异步处理。</p>
<h2 id="Curator食谱-高级特性"><a href="#Curator食谱-高级特性" class="headerlink" title="Curator食谱(高级特性)"></a>Curator食谱(高级特性)</h2><p><strong>提醒：首先你必须添加curator-recipes依赖，下文仅仅对recipes一些特性的使用进行解释和举例，不打算进行源码级别的探讨</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-recipes<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.12.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>重要提醒：强烈推荐使用ConnectionStateListener监控连接的状态，当连接状态为LOST，curator-recipes下的所有Api将会失效或者过期，尽管后面所有的例子都没有使用到ConnectionStateListener。</strong></p>
<h3 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h3><p>Zookeeper原生支持通过注册Watcher来进行事件监听，但是开发者需要反复注册(Watcher只能单次注册单次使用)。Cache是Curator中对事件监听的包装，可以看作是对事件监听的本地缓存视图，能够自动为开发者处理反复注册监听。Curator提供了三种Watcher(Cache)来监听结点的变化。</p>
<h4 id="Path-Cache"><a href="#Path-Cache" class="headerlink" title="Path Cache"></a>Path Cache</h4><p>Path Cache用来监控一个ZNode的子节点. 当一个子节点增加， 更新，删除时， Path Cache会改变它的状态， 会包含最新的子节点， 子节点的数据和状态，而状态的更变将通过PathChildrenCacheListener通知。</p>
<p>实际使用时会涉及到四个类：</p>
<ul>
<li>PathChildrenCache</li>
<li>PathChildrenCacheEvent</li>
<li>PathChildrenCacheListener</li>
<li>ChildData</li>
</ul>
<p>通过下面的构造函数创建Path Cache:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PathChildrenCache</span><span class="params">(CuratorFramework client, String path, <span class="keyword">boolean</span> cacheData)</span></span></span><br></pre></td></tr></table></figure>

<p>想使用cache，必须调用它的<code>start</code>方法，使用完后调用<code>close</code>方法。 可以设置StartMode来实现启动的模式</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://veysky.github.io/blogOfLin/2020/10/16/zookeeper-%E5%AE%A2%E6%88%B7%E7%AB%AFCurator%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3/" data-id="cklj6bnow000tswn4ha136hdk" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Zookeeper-Docker下安装部署" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blogOfLin/2020/10/16/Zookeeper-Docker%E4%B8%8B%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/" class="article-date">
  <time datetime="2020-10-16T12:27:46.000Z" itemprop="datePublished">2020-10-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blogOfLin/2020/10/16/Zookeeper-Docker%E4%B8%8B%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/">Zookeeper  Docker下安装部署</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="单节点安装"><a href="#单节点安装" class="headerlink" title="单节点安装"></a>单节点安装</h1><h2 id="一、-环境说明"><a href="#一、-环境说明" class="headerlink" title="一、 环境说明"></a>一、 环境说明</h2><ul>
<li>docker: 18.09.9-ce</li>
<li>zookeeper: 3.5.6</li>
</ul>
<h2 id="二、-拉取-zookeeper-镜像"><a href="#二、-拉取-zookeeper-镜像" class="headerlink" title="二、 拉取 zookeeper 镜像"></a>二、 拉取 zookeeper 镜像</h2><ul>
<li><strong>拉取镜像</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull zookeeper</span><br></pre></td></tr></table></figure>

<p>默认是摘取最新版本 <strong>zookeeper:latest</strong>。</p>
<ul>
<li><strong>查看当前镜像</strong></li>
</ul>
<p><img src="https://img2018.cnblogs.com/i-beta/1577453/202002/1577453-20200218110311103-1391656531.png" alt="img"></p>
<h2 id="三、-准备工作"><a href="#三、-准备工作" class="headerlink" title="三、 准备工作"></a>三、 准备工作</h2><p>将它部署在 /usr/local/zookeeper 目录下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;usr&#x2F;local &amp;&amp; mkdir zookeeper &amp;&amp; cd zookeeper</span><br></pre></td></tr></table></figure>

<p>创建data目录，用于挂载容器中的数据目录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir data</span><br></pre></td></tr></table></figure>

<p><img src="https://img2018.cnblogs.com/i-beta/1577453/202002/1577453-20200218110633631-1450938810.png" alt="img"></p>
<h2 id="四、-正式部署"><a href="#四、-正式部署" class="headerlink" title="四、 正式部署"></a>四、 正式部署</h2><ul>
<li><strong>部署命令：</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -e TZ&#x3D;&quot;Asia&#x2F;Shanghai&quot; -p 2181:2181 -v $PWD&#x2F;data:&#x2F;data --name zookeeper --restart always zookeeper</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>命令详细说明：</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-e TZ&#x3D;&quot;Asia&#x2F;Shanghai&quot; # 指定上海时区 </span><br><span class="line">-d # 表示在一直在后台运行容器</span><br><span class="line">-p 2181:2181 # 对端口进行映射，将本地2181端口映射到容器内部的2181端口</span><br><span class="line">--name # 设置创建的容器名称</span><br><span class="line">-v # 将本地目录(文件)挂载到容器指定目录；</span><br><span class="line">--restart always #始终重新启动zookeeper</span><br></pre></td></tr></table></figure>



<ul>
<li><strong>查看容器启动情况：</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps -a</span><br></pre></td></tr></table></figure>

<p><img src="https://img2018.cnblogs.com/i-beta/1577453/202002/1577453-20200218111223382-266770946.png" alt="img"></p>
<p>注：状态（STATUS）为Up，说明容器已经启动成功。</p>
<h2 id="五、-测试"><a href="#五、-测试" class="headerlink" title="五、 测试"></a>五、 测试</h2><ul>
<li><strong>使用zk命令行客户端连接zk</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --rm --link zookeeper:zookeeper zookeeper zkCli.sh -server zookeeper</span><br></pre></td></tr></table></figure>

<p>说明：<code>-server zookeeper</code>是启动<code>zkCli.sh</code>的参数</p>
<p><img src="https://img2018.cnblogs.com/i-beta/1577453/202002/1577453-20200218111608512-516451599.png" alt="img"></p>
<p><img src="https://img2018.cnblogs.com/i-beta/1577453/202002/1577453-20200218111735060-225718424.png" alt="img"></p>
<h2 id="六、-其它命令"><a href="#六、-其它命令" class="headerlink" title="六、 其它命令"></a>六、 其它命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 查看zookeeper容器实例进程信息</span><br><span class="line">docker top zookeeper</span><br><span class="line"></span><br><span class="line"># 停止zookeeper实例进程</span><br><span class="line">docker stop zookeeper</span><br><span class="line"></span><br><span class="line"># 启动zookeeper实例进程</span><br><span class="line">docker start zookeeper</span><br><span class="line"></span><br><span class="line"># 重启zookeeper实例进程</span><br><span class="line">docker restart zookeeper</span><br><span class="line"></span><br><span class="line"># 查看zookeeper进程日志</span><br><span class="line">docker logs -f zookeeper</span><br><span class="line"></span><br><span class="line"># 杀死zookeeper实例进程</span><br><span class="line">docker kill -s KILL zookeeper</span><br><span class="line"></span><br><span class="line"># 移除zookeeper实例</span><br><span class="line">docker rm -f -v zookeeper</span><br></pre></td></tr></table></figure>

<h1 id="集群方式安装"><a href="#集群方式安装" class="headerlink" title="集群方式安装"></a>集群方式安装</h1><p>集群方式选择使用<code>docker-compose</code>来完成。</p>
<h2 id="一、安装docker-compose"><a href="#一、安装docker-compose" class="headerlink" title="一、安装docker-compose"></a>一、安装docker-compose</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -L https:&#x2F;&#x2F;github.com&#x2F;docker&#x2F;compose&#x2F;releases&#x2F;download&#x2F;1.22.0&#x2F;docker-compose-&#96;uname -s&#96;-&#96;uname -m&#96; -o &#x2F;usr&#x2F;local&#x2F;bin&#x2F;docker-compose</span><br><span class="line">chmod +x &#x2F;usr&#x2F;local&#x2F;bin&#x2F;docker-compose</span><br></pre></td></tr></table></figure>





<h2 id="二、配置docker-compose"><a href="#二、配置docker-compose" class="headerlink" title="二、配置docker-compose"></a>二、配置docker-compose</h2><p>编写配置文件，并将其命名为：<code>docker-compose.yml</code>（<code>docker-compose</code>默认配置文件名）<br>配置文件内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">version: &#39;2&#39;</span><br><span class="line">services:</span><br><span class="line">    zoo1:</span><br><span class="line">        image: zookeeper</span><br><span class="line">        restart: always</span><br><span class="line">        container_name: zoo1</span><br><span class="line">        ports:</span><br><span class="line">            - &quot;2181:2181&quot;</span><br><span class="line">        environment:</span><br><span class="line">            ZOO_MY_ID: 1</span><br><span class="line">            ZOO_SERVERS: server.1&#x3D;zoo1:2888:3888 server.2&#x3D;zoo2:2888:3888 server.3&#x3D;zoo3:2888:3888</span><br><span class="line"></span><br><span class="line">    zoo2:</span><br><span class="line">        image: zookeeper</span><br><span class="line">        restart: always</span><br><span class="line">        container_name: zoo2</span><br><span class="line">        ports:</span><br><span class="line">            - &quot;2182:2181&quot;</span><br><span class="line">        environment:</span><br><span class="line">            ZOO_MY_ID: 2</span><br><span class="line">            ZOO_SERVERS: server.1&#x3D;zoo1:2888:3888 server.2&#x3D;zoo2:2888:3888 server.3&#x3D;zoo3:2888:3888</span><br><span class="line"></span><br><span class="line">    zoo3:</span><br><span class="line">        image: zookeeper</span><br><span class="line">        restart: always</span><br><span class="line">        container_name: zoo3</span><br><span class="line">        ports:</span><br><span class="line">            - &quot;2183:2181&quot;</span><br><span class="line">        environment:</span><br><span class="line">            ZOO_MY_ID: 3</span><br><span class="line">            ZOO_SERVERS: server.1&#x3D;zoo1:2888:3888 server.2&#x3D;zoo2:2888:3888 server.3&#x3D;zoo3:2888:3888</span><br></pre></td></tr></table></figure>

<p>此配置文件表示，Docker需要启动三个zookeeper实例，并将2181，2182，2183三个端口号映射到容器内的2181这个端口上。<br><code>ZOO_MY_ID</code>：表示zk服务的ID, 取值为1-255之间的整数，且必须唯一<br><code>ZOO_SERVERS</code>：表示zk集群的主机列表</p>
<h2 id="三、启动zookeeper集群"><a href="#三、启动zookeeper集群" class="headerlink" title="三、启动zookeeper集群"></a>三、启动zookeeper集群</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>该命令执行需要在<code>docker-compose</code>配置文件的目录下执行，结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@izbp13xko46hud9vfr5s94z conf]# docker-compose up -d </span><br><span class="line">Starting zoo1 ... done</span><br><span class="line">Starting zoo2 ... done</span><br><span class="line">Starting zoo3 ... done</span><br><span class="line">[root@izbp13xko46hud9vfr5s94z conf]# </span><br></pre></td></tr></table></figure>





<h2 id="四、查看zookeeper集群实例"><a href="#四、查看zookeeper集群实例" class="headerlink" title="四、查看zookeeper集群实例"></a>四、查看zookeeper集群实例</h2><ul>
<li><strong>通过<code>docker ps</code>查看</strong></li>
</ul>
<p>[root@izbp13xko46hud9vfr5s94z ~]# docker ps<br>CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES<br>e53b4c838001 zookeeper “/docker-entrypoint.…” 4 minutes ago Up 44 seconds 2888/tcp, 0.0.0.0:2181-&gt;2181/tcp, 3888/tcp zoo1<br>19282fb6f9b4 zookeeper “/docker-entrypoint.…” 4 minutes ago Up 44 seconds 2888/tcp, 3888/tcp, 0.0.0.0:2182-&gt;2181/tcp zoo2<br>099b926fa2d3 zookeeper “/docker-entrypoint.…” 4 minutes ago Up 44 seconds 2888/tcp, 3888/tcp, 0.0.0.0:2183-&gt;2181/tcp zoo3</p>
<ul>
<li><strong>通过<code>docker-compose ps</code>查看</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@izbp13xko46hud9vfr5s94z conf]# docker-compose ps </span><br><span class="line">Name              Command               State                     Ports                   </span><br><span class="line">------------------------------------------------------------------------------------------</span><br><span class="line">zoo1   &#x2F;docker-entrypoint.sh zkSe ...   Up      0.0.0.0:2181-&gt;2181&#x2F;tcp, 2888&#x2F;tcp, 3888&#x2F;tcp</span><br><span class="line">zoo2   &#x2F;docker-entrypoint.sh zkSe ...   Up      0.0.0.0:2182-&gt;2181&#x2F;tcp, 2888&#x2F;tcp, 3888&#x2F;tcp</span><br><span class="line">zoo3   &#x2F;docker-entrypoint.sh zkSe ...   Up      0.0.0.0:2183-&gt;2181&#x2F;tcp, 2888&#x2F;tcp, 3888&#x2F;tcp</span><br><span class="line">[root@izbp13xko46hud9vfr5s94z conf]# </span><br></pre></td></tr></table></figure>



<p>注：这个命令需要在<code>docker-compose</code>配置文件下执行。 </p>
<h2 id="五、管理docker-compose服务"><a href="#五、管理docker-compose服务" class="headerlink" title="五、管理docker-compose服务"></a>五、管理docker-compose服务</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 停止docker-compose服务</span><br><span class="line">docker-compose stop</span><br><span class="line"></span><br><span class="line"># 启动docker-compose服务</span><br><span class="line">docker-compose start </span><br><span class="line"># 重启docker-compose服务</span><br><span class="line">docker-compose restart </span><br></pre></td></tr></table></figure>







<h2 id="六、查看zookeeper集群节点主从关系"><a href="#六、查看zookeeper集群节点主从关系" class="headerlink" title="六、查看zookeeper集群节点主从关系"></a>六、查看zookeeper集群节点主从关系</h2><p>使用<code>docker exec -it zoo1 /bin/bash</code>这个命令进入<code>zoo1</code>节点中，之后输入<code>./bin/zkServer.sh statu</code>来查看节点主从关系</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@izbp13xko46hud9vfr5s94z conf]# docker exec -it zoo1 &#x2F;bin&#x2F;bash </span><br><span class="line">bash-4.4# .&#x2F;bin&#x2F;zkServer.sh status</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: &#x2F;conf&#x2F;zoo.cfg</span><br><span class="line">Mode: follower</span><br><span class="line">bash-4.4# </span><br></pre></td></tr></table></figure>



      
    </div>
    <footer class="article-footer">
      <a data-url="https://veysky.github.io/blogOfLin/2020/10/16/Zookeeper-Docker%E4%B8%8B%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/" data-id="cklj6bnoj0008swn4147q0kf0" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blogOfLin/tags/zookeeper-docker-ZkCli-sh/" rel="tag">zookeeper, docker, ZkCli.sh</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-MySQL-主键自增，会出现跳键" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blogOfLin/2020/09/28/MySQL-%E4%B8%BB%E9%94%AE%E8%87%AA%E5%A2%9E%EF%BC%8C%E4%BC%9A%E5%87%BA%E7%8E%B0%E8%B7%B3%E9%94%AE/" class="article-date">
  <time datetime="2020-09-28T08:49:38.000Z" itemprop="datePublished">2020-09-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blogOfLin/2020/09/28/MySQL-%E4%B8%BB%E9%94%AE%E8%87%AA%E5%A2%9E%EF%BC%8C%E4%BC%9A%E5%87%BA%E7%8E%B0%E8%B7%B3%E9%94%AE/">MySQL 主键自增，会出现跳键</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="https://img-blog.csdnimg.cn/20190124110818112.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zOTI5NzMxMg==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20190124111024876.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zOTI5NzMxMg==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>这个表记录的是设备的心跳数据,记录设备第一次上传心跳的时间和最后一次上传数据的时间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    我的sql:</span><br><span class="line">        insert into tb_ap_heart (ap_id, create_time, update_time)</span><br><span class="line">        values (#&#123;apId,jdbcType&#x3D;VARCHAR&#125;, #&#123;createTime,jdbcType&#x3D;TIMESTAMP&#125;,</span><br><span class="line">        #&#123;updateTime,jdbcType&#x3D;TIMESTAMP&#125;)</span><br><span class="line">        ON DUPLICATE KEY UPDATE </span><br><span class="line">        update_time&#x3D;values(update_time)</span><br><span class="line">123456</span><br></pre></td></tr></table></figure>

<p>根据主键只修改更新时间</p>
<p>通过查找资料发现on duplicate key update有一个特性就是每次是更新的情况下id也是会自增加1的，比如说现在id最大值的153889，然后进行了一次更新操作再进行一次插入操作时，id的值就变成了153891而不是153890。<br>再进行一次插入更新操作,id值就变成了153892<br>我是经过自己测试的,</p>
<p>我自用的解决方法: 先查询 再更新有改变的数据</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://veysky.github.io/blogOfLin/2020/09/28/MySQL-%E4%B8%BB%E9%94%AE%E8%87%AA%E5%A2%9E%EF%BC%8C%E4%BC%9A%E5%87%BA%E7%8E%B0%E8%B7%B3%E9%94%AE/" data-id="cklj6bnoe0004swn4dhw7hxmt" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/blogOfLin/">&amp;laquo; Prev</a><a class="page-number" href="/blogOfLin/">1</a><span class="page-number current">2</span><a class="page-number" href="/blogOfLin/page/3/">3</a><a class="extend next" rel="next" href="/blogOfLin/page/3/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/blogOfLin/tags/mvn-skip-module/" rel="tag">mvn, skip,module</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blogOfLin/tags/mysql-unix-timestamp-from-unixtime-date-format/" rel="tag">mysql,unix_timestamp,from_unixtime,date_format</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blogOfLin/tags/mysqldump/" rel="tag">mysqldump</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blogOfLin/tags/zkCli-sh-%E5%AE%A2%E6%88%B7%E7%AB%AF-%E5%91%BD%E4%BB%A4-ZooKeeper/" rel="tag">zkCli.sh, 客户端, 命令, ZooKeeper</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blogOfLin/tags/zookeeper-docker-ZkCli-sh/" rel="tag">zookeeper, docker, ZkCli.sh</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/blogOfLin/tags/mvn-skip-module/" style="font-size: 10px;">mvn, skip,module</a> <a href="/blogOfLin/tags/mysql-unix-timestamp-from-unixtime-date-format/" style="font-size: 10px;">mysql,unix_timestamp,from_unixtime,date_format</a> <a href="/blogOfLin/tags/mysqldump/" style="font-size: 10px;">mysqldump</a> <a href="/blogOfLin/tags/zkCli-sh-%E5%AE%A2%E6%88%B7%E7%AB%AF-%E5%91%BD%E4%BB%A4-ZooKeeper/" style="font-size: 10px;">zkCli.sh, 客户端, 命令, ZooKeeper</a> <a href="/blogOfLin/tags/zookeeper-docker-ZkCli-sh/" style="font-size: 10px;">zookeeper, docker, ZkCli.sh</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blogOfLin/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blogOfLin/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blogOfLin/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blogOfLin/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blogOfLin/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blogOfLin/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blogOfLin/archives/2020/08/">August 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blogOfLin/2021/02/24/app%E6%8A%93%E5%8C%85%E9%97%AE%E9%A2%98/">app抓包问题</a>
          </li>
        
          <li>
            <a href="/blogOfLin/2021/02/10/pure-ftp%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AE/">pure-ftp安装和配置</a>
          </li>
        
          <li>
            <a href="/blogOfLin/2021/02/05/Java-Optional-%E2%80%93-orElse-vs-orElseGet/">Java Optional – orElse() vs orElseGet()</a>
          </li>
        
          <li>
            <a href="/blogOfLin/2021/02/05/idea-%E6%8E%A8%E8%8D%90%E6%8F%92%E4%BB%B6/">idea 推荐插件</a>
          </li>
        
          <li>
            <a href="/blogOfLin/2021/01/27/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Redis%E7%9A%84scan%E5%91%BD%E4%BB%A4/">深入理解Redis的scan命令</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/blogOfLin/" class="mobile-nav-link">Home</a>
  
    <a href="/blogOfLin/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/blogOfLin/fancybox/jquery.fancybox.css">

  
<script src="/blogOfLin/fancybox/jquery.fancybox.pack.js"></script>




<script src="/blogOfLin/js/script.js"></script>




  </div>
</body>
</html>